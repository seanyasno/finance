---
phase: 06-search-functionality
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/transactions/dto/transaction.dto.ts
  - apps/api/src/transactions/transactions.service.ts
autonomous: true

must_haves:
  truths:
    - "API accepts search query parameter and returns filtered transactions"
    - "Search matches against transaction description (merchant name)"
    - "Search matches against transaction amount"
    - "Search matches against transaction notes"
    - "Search is case-insensitive"
  artifacts:
    - path: "apps/api/src/transactions/dto/transaction.dto.ts"
      provides: "TransactionQuerySchema with search field"
      contains: "search:"
    - path: "apps/api/src/transactions/transactions.service.ts"
      provides: "Prisma OR query for search filtering"
      contains: "OR:"
  key_links:
    - from: "apps/api/src/transactions/transactions.controller.ts"
      to: "apps/api/src/transactions/transactions.service.ts"
      via: "query.search passed to service"
      pattern: "findAll.*query"
---

<objective>
Add server-side search capability to the transactions API endpoint.

Purpose: Enable real-time transaction filtering by merchant name, amount, or notes through a single search query parameter.
Output: `GET /transactions?search=xyz` returns transactions matching the search term across description, amount, and notes fields.
</objective>

<execution_context>
@/Users/seanyasno/.claude/get-shit-done/workflows/execute-plan.md
@/Users/seanyasno/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-search-functionality/06-CONTEXT.md
@apps/api/src/transactions/dto/transaction.dto.ts
@apps/api/src/transactions/transactions.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add search parameter to TransactionQueryDto</name>
  <files>apps/api/src/transactions/dto/transaction.dto.ts</files>
  <action>
Add `search` field to TransactionQuerySchema:
- Type: `z.string().optional()`
- This will be the single search term that matches against multiple fields

The DTO already has startDate, endDate, creditCardId. Add search as a new optional field.
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd apps/api && npx tsc --noEmit
```
  </verify>
  <done>TransactionQueryDto accepts optional search string parameter</done>
</task>

<task type="auto">
  <name>Task 2: Implement search filtering in transactions service</name>
  <files>apps/api/src/transactions/transactions.service.ts</files>
  <action>
Modify the `findAll` method to filter by search term when provided:

1. If `query.search` is provided:
   - Add an OR condition that matches:
     - `description` contains search term (case-insensitive) - this is the merchant name
     - `original_amount` as string contains search term (convert number to string for partial matching)
     - `notes` contains search term (case-insensitive)

2. Prisma pattern for case-insensitive contains:
```typescript
description: {
  contains: query.search,
  mode: 'insensitive'
}
```

3. For amount matching, use Prisma's raw query or convert to string comparison:
   - Simplest approach: Cast amount to string and use contains
   - Alternative: Parse search as number if numeric, then exact/partial match

4. Combine with existing filters (user_id, date range, credit card) using AND logic:
   - User must always match
   - Date filters AND search filters both apply

Example structure:
```typescript
const searchConditions = query.search ? {
  OR: [
    { description: { contains: query.search, mode: 'insensitive' as const } },
    { notes: { contains: query.search, mode: 'insensitive' as const } },
    // Amount handling - see implementation notes
  ]
} : {};

const whereClause = {
  user_id: userId,
  AND: [
    searchConditions,
    // existing date/card filters
  ].filter(condition => Object.keys(condition).length > 0)
};
```

Note: For amount search, consider using Prisma's raw filter or a computed approach. A pragmatic solution is to search description and notes only for non-numeric searches, and add amount filtering if the search term is numeric.
  </action>
  <verify>
1. TypeScript compiles:
```bash
cd apps/api && npx tsc --noEmit
```

2. Run existing tests to ensure no regression:
```bash
cd apps/api && npm run test
```

3. Manual API test (requires running server):
```bash
# Start server in another terminal: cd apps/api && npm run start:dev
# Then test:
curl -s "http://localhost:3000/api/transactions?search=amazon" -H "Authorization: Bearer $TOKEN" | head -100
```
  </verify>
  <done>
- Search term filters transactions by description (merchant) case-insensitively
- Search term filters transactions by notes case-insensitively
- Search works in combination with existing date and card filters
- Empty search parameter returns all transactions (no filter)
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors in apps/api
2. API accepts `?search=` query parameter without validation errors
3. Search is case-insensitive (searching "AMAZON" matches "amazon")
4. Search works with other filters (search + creditCardId both filter)
5. OpenAPI spec reflects new search parameter for iOS codegen
</verification>

<success_criteria>
- GET /transactions?search=merchant returns transactions where description contains "merchant"
- GET /transactions?search=note returns transactions where notes contain "note"
- Search is case-insensitive
- Empty search returns all transactions
- Existing date and card filters continue to work alongside search
</success_criteria>

<output>
After completion, create `.planning/phases/06-search-functionality/06-01-SUMMARY.md`
</output>
