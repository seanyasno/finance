---
phase: 06-search-functionality
plan: 03
type: execute
wave: 3
depends_on: ["06-01", "06-02"]
files_modified:
  - apps/api/src/transactions/transactions.service.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Searching for a numeric value matches transactions with amounts containing that value (partial matching)"
    - "Partial amount matching works (searching '100' matches '100.50' and '1000')"
    - "Non-numeric searches continue to work (description and notes matching)"
    - "Numeric searches ALSO match text fields (search '100' matches amount 100 AND description containing '100')"
  artifacts:
    - path: "apps/api/src/transactions/transactions.service.ts"
      provides: "Amount search with partial matching via raw SQL"
      contains: "original_amount"
  key_links:
    - from: "query.search"
      to: "whereClause.OR"
      via: "amount condition added using raw SQL CAST for partial string matching"
      pattern: "CAST.*original_amount.*TEXT"
    - from: "query.search"
      to: "numeric detection"
      via: "regex test before raw SQL query"
      pattern: "/\\^-\\?\\\\d\\*\\\\.\\?\\\\d\\+\\$/"
---

<objective>
Add amount search capability to transaction search API

Purpose: Close verification gap - phase must-have #3 "Search filters by amount, matching exact or partial values" is not implemented
Output: Transactions service that includes original_amount in search OR conditions
</objective>

<execution_context>
@/Users/seanyasno/.claude/get-shit-done/workflows/execute-plan.md
@/Users/seanyasno/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/06-search-functionality/06-VERIFICATION.md

# Gap source
The verification report found that amount search is not implemented:
- Truth failed: "Search filters by amount, matching exact or partial values"
- Current OR clause only includes description and notes, not original_amount
- The field original_amount is a Float in the database schema

# Prior implementation
@.planning/phases/06-search-functionality/06-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add amount search to transactions service OR clause</name>
  <files>apps/api/src/transactions/transactions.service.ts</files>
  <action>
Modify the search filter logic in findAll() to include PARTIAL amount matching.

The challenge: original_amount is a Float, but search is a string. Prisma does not support "contains" for numeric fields. The requirement is for PARTIAL matching - searching "100" must match amounts like 100, 100.50, 1000, etc.

**Implementation approach - Hybrid query with raw SQL for amount matching:**

Use a two-step approach: first query for amount-matching IDs via raw SQL, then ADD those IDs to the existing OR conditions (not replace). This ensures numeric searches match BOTH amount AND text fields.

**Integration pattern - ADD to existing OR, not replace:**

The current code builds `whereClause.OR` with description and notes conditions when `query.search` exists (lines 36-49). The amount matching will ADD a third condition to this OR array, so:
- Numeric search "100" matches: description containing "100" OR notes containing "100" OR amount containing "100"
- Non-numeric search "coffee" matches: description containing "coffee" OR notes containing "coffee" (no amount condition added)

**Implementation steps:**

1. Keep existing code that builds `whereClause.OR` with description/notes (lines 36-49)
2. AFTER the existing OR array is built, check if search term is numeric using regex: `/^-?\d*\.?\d+$/`
3. If numeric, execute raw SQL query to find matching transaction IDs
4. Push a third condition to `whereClause.OR` with the matching IDs

**Exact code changes in findAll():**

```typescript
// Add search filter if provided (existing code, keep as-is)
if (query.search) {
  whereClause.OR = [
    {
      description: {
        contains: query.search,
        mode: 'insensitive' as const,
      },
    },
    {
      notes: {
        contains: query.search,
        mode: 'insensitive' as const,
      },
    },
  ];

  // NEW: Add amount matching for numeric searches
  const isNumericSearch = /^-?\d*\.?\d+$/.test(query.search);
  if (isNumericSearch) {
    // Raw SQL for partial amount matching (CAST to TEXT for LIKE)
    const amountMatchIds = await this.prisma.$queryRaw<{ id: string }[]>`
      SELECT id FROM transactions
      WHERE user_id = ${userId}
      AND CAST(original_amount AS TEXT) LIKE ${'%' + query.search + '%'}
    `;

    // Add to OR clause (combines with description/notes matching)
    if (amountMatchIds.length > 0) {
      whereClause.OR.push({
        id: { in: amountMatchIds.map(row => row.id) }
      });
    }
  }
}
```

**Key requirements:**
- Searching "100" MUST match amounts: 100, 100.50, 100.00, 1000, -100, etc.
- Searching "100" ALSO matches description or notes containing "100" (OR logic)
- Searching "49.90" MUST match amounts: 49.90, 149.90, etc.
- Non-numeric searches (e.g., "coffee") continue to match description and notes only (no amount condition added)
- Existing functionality must not regress
  </action>
  <verify>
Run API tests:
```bash
cd /Users/seanyasno/Developer/finance/apps/api && npm run test
```

Manual verification (requires running API):
```bash
# Search for a numeric value - should return transactions with that exact amount
curl -H "Authorization: Bearer $TOKEN" "http://localhost:3000/transactions?search=49.90"
```
  </verify>
  <done>
- Partial amount matching works: searching "100" matches transactions with amounts 100, 100.50, 1000, -100, etc.
- Searching "49.90" matches transactions with amounts containing "49.90" (e.g., 49.90, 149.90)
- Searching for a non-numeric string continues to match description and notes
- No regressions in existing search functionality
  </done>
</task>

</tasks>

<verification>
1. Code compiles: `cd apps/api && npm run build`
2. Tests pass: `cd apps/api && npm run test`
3. Search logic includes amount condition when search term is numeric
4. Non-numeric searches work unchanged (description/notes matching)
</verification>

<success_criteria>
- [ ] Transactions service includes amount in search OR conditions via raw SQL CAST
- [ ] Numeric search terms match amounts PARTIALLY (searching "100" matches 100, 100.50, 1000)
- [ ] Non-numeric searches continue to work for description/notes
- [ ] All existing tests pass
- [ ] Phase must-have #3 is satisfied: "Search filters by amount, matching exact or partial values"
</success_criteria>

<output>
After completion, create `.planning/phases/06-search-functionality/06-03-SUMMARY.md`
</output>
