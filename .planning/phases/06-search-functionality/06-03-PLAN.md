---
phase: 06-search-functionality
plan: 03
type: execute
wave: 3
depends_on: ["06-01", "06-02"]
files_modified:
  - apps/api/src/transactions/transactions.service.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Searching for a numeric value matches transactions with amounts containing that value (partial matching)"
    - "Partial amount matching works (searching '100' matches '100.50' and '1000')"
    - "Non-numeric searches continue to work (description and notes matching)"
  artifacts:
    - path: "apps/api/src/transactions/transactions.service.ts"
      provides: "Amount search with partial matching via raw SQL"
      contains: "original_amount"
  key_links:
    - from: "query.search"
      to: "whereClause.OR"
      via: "amount condition added using raw SQL CAST for partial string matching"
      pattern: "CAST.*original_amount.*TEXT"
---

<objective>
Add amount search capability to transaction search API

Purpose: Close verification gap - phase must-have #3 "Search filters by amount, matching exact or partial values" is not implemented
Output: Transactions service that includes original_amount in search OR conditions
</objective>

<execution_context>
@/Users/seanyasno/.claude/get-shit-done/workflows/execute-plan.md
@/Users/seanyasno/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/06-search-functionality/06-VERIFICATION.md

# Gap source
The verification report found that amount search is not implemented:
- Truth failed: "Search filters by amount, matching exact or partial values"
- Current OR clause only includes description and notes, not original_amount
- The field original_amount is a Float in the database schema

# Prior implementation
@.planning/phases/06-search-functionality/06-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add amount search to transactions service OR clause</name>
  <files>apps/api/src/transactions/transactions.service.ts</files>
  <action>
Modify the search filter logic in findAll() to include PARTIAL amount matching.

The challenge: original_amount is a Float, but search is a string. Prisma does not support "contains" for numeric fields. The requirement is for PARTIAL matching - searching "100" must match amounts like 100, 100.50, 1000, etc.

**REQUIRED Implementation approach - Partial matching via raw SQL:**

Since Prisma Float fields cannot use "contains", use Prisma's raw query capability to cast the amount to text and perform string matching.

**Implementation steps:**

1. Check if the search term looks numeric (contains only digits, optional decimal point, optional minus sign)
2. If numeric, use a hybrid approach:
   - Keep the existing Prisma query for description/notes matching
   - Add a separate raw SQL query for amount matching with CAST
   - Combine results (OR logic)

**For PostgreSQL database:**
```typescript
// In findAll(), when query.search is provided and looks numeric:
const isNumericSearch = /^-?\d*\.?\d+$/.test(query.search);

if (isNumericSearch) {
  // Use raw SQL for partial amount matching
  // CAST(original_amount AS TEXT) LIKE '%{search}%'
  const amountMatchIds = await this.prisma.$queryRaw<{ id: string }[]>`
    SELECT id FROM transactions
    WHERE user_id = ${userId}
    AND CAST(original_amount AS TEXT) LIKE ${'%' + query.search + '%'}
  `;

  // Add these IDs to the OR clause
  if (amountMatchIds.length > 0) {
    whereClause.OR.push({
      id: { in: amountMatchIds.map(r => r.id) }
    });
  }
}
```

**Alternative - simpler single query approach (preferred if Prisma supports):**
If using PostgreSQL, you can use `$queryRaw` for the entire query when search is numeric, or keep the standard Prisma approach for text-only searches.

**Key requirements:**
- Searching "100" MUST match amounts: 100, 100.50, 100.00, 1000, -100, etc.
- Searching "49.90" MUST match amounts: 49.90, 149.90, etc.
- Non-numeric searches (e.g., "coffee") continue to match description and notes only
- Existing functionality must not regress
  </action>
  <verify>
Run API tests:
```bash
cd /Users/seanyasno/Developer/finance/apps/api && npm run test
```

Manual verification (requires running API):
```bash
# Search for a numeric value - should return transactions with that exact amount
curl -H "Authorization: Bearer $TOKEN" "http://localhost:3000/transactions?search=49.90"
```
  </verify>
  <done>
- Partial amount matching works: searching "100" matches transactions with amounts 100, 100.50, 1000, -100, etc.
- Searching "49.90" matches transactions with amounts containing "49.90" (e.g., 49.90, 149.90)
- Searching for a non-numeric string continues to match description and notes
- No regressions in existing search functionality
  </done>
</task>

</tasks>

<verification>
1. Code compiles: `cd apps/api && npm run build`
2. Tests pass: `cd apps/api && npm run test`
3. Search logic includes amount condition when search term is numeric
4. Non-numeric searches work unchanged (description/notes matching)
</verification>

<success_criteria>
- [ ] Transactions service includes amount in search OR conditions via raw SQL CAST
- [ ] Numeric search terms match amounts PARTIALLY (searching "100" matches 100, 100.50, 1000)
- [ ] Non-numeric searches continue to work for description/notes
- [ ] All existing tests pass
- [ ] Phase must-have #3 is satisfied: "Search filters by amount, matching exact or partial values"
</success_criteria>

<output>
After completion, create `.planning/phases/06-search-functionality/06-03-SUMMARY.md`
</output>
