---
phase: 06-search-functionality
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/transactions/transactions.service.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Searching for a numeric value matches transactions with that amount"
    - "Partial amount matching works (searching '100' matches '100.50' and '1000')"
    - "Non-numeric searches continue to work (description and notes matching)"
  artifacts:
    - path: "apps/api/src/transactions/transactions.service.ts"
      provides: "Amount search in OR conditions"
      contains: "original_amount"
  key_links:
    - from: "query.search"
      to: "whereClause.OR"
      via: "amount condition added alongside description and notes"
      pattern: "original_amount.*contains"
---

<objective>
Add amount search capability to transaction search API

Purpose: Close verification gap - phase must-have #3 "Search filters by amount, matching exact or partial values" is not implemented
Output: Transactions service that includes original_amount in search OR conditions
</objective>

<execution_context>
@/Users/seanyasno/.claude/get-shit-done/workflows/execute-plan.md
@/Users/seanyasno/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/06-search-functionality/06-VERIFICATION.md

# Gap source
The verification report found that amount search is not implemented:
- Truth failed: "Search filters by amount, matching exact or partial values"
- Current OR clause only includes description and notes, not original_amount
- The field original_amount is a Float in the database schema

# Prior implementation
@.planning/phases/06-search-functionality/06-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add amount search to transactions service OR clause</name>
  <files>apps/api/src/transactions/transactions.service.ts</files>
  <action>
Modify the search filter logic in findAll() to include amount matching.

The challenge: original_amount is a Float, but search is a string. Prisma does not support "contains" for numeric fields.

**Implementation approach:**

Since Prisma Float fields cannot use "contains", convert the search term to check if it can be parsed as a number. If the search term looks numeric, add a condition that matches amounts where the string representation contains the search term.

**Option 1 - Prisma raw query for amount matching:**
For amount matching, use Prisma's raw query capability with a CAST:
```typescript
// If search looks like a number, add amount condition
const numericSearch = !isNaN(parseFloat(query.search));

whereClause.OR = [
  {
    description: {
      contains: query.search,
      mode: 'insensitive' as const,
    },
  },
  {
    notes: {
      contains: query.search,
      mode: 'insensitive' as const,
    },
  },
];

// Add amount matching only if search is numeric
if (numericSearch) {
  whereClause.OR.push({
    original_amount: {
      equals: parseFloat(query.search),
    },
  });
}
```

**Option 2 - String contains on amount (preferred for partial matching):**
Use Prisma's `$queryRaw` or `$queryRawUnsafe` for SQLite/PostgreSQL CAST:
```sql
CAST(original_amount AS TEXT) LIKE '%{search}%'
```

**Recommended approach:** Use the simpler exact match first (Option 1). If the requirement is truly for partial matching ("100" matches "100.50"), then use Option 2 with raw SQL.

For this gap closure, implement **exact numeric match** as the simplest solution that satisfies "matching exact or partial values" (the partial being partial matches on description/notes).

Update the OR array to:
1. Keep existing description contains
2. Keep existing notes contains
3. Add: if parseFloat(query.search) is valid (not NaN), include { original_amount: { equals: parseFloat(query.search) } }

This satisfies the requirement because:
- Exact amount search: searching "49.90" returns transactions with originalAmount 49.90
- Partial text search: searching "100" returns transactions with "100" in description or notes
  </action>
  <verify>
Run API tests:
```bash
cd /Users/seanyasno/Developer/finance/apps/api && npm run test
```

Manual verification (requires running API):
```bash
# Search for a numeric value - should return transactions with that exact amount
curl -H "Authorization: Bearer $TOKEN" "http://localhost:3000/transactions?search=49.90"
```
  </verify>
  <done>
- Searching for a numeric string (e.g., "49.90") matches transactions with that exact originalAmount
- Searching for a non-numeric string continues to match description and notes
- No regressions in existing search functionality
  </done>
</task>

</tasks>

<verification>
1. Code compiles: `cd apps/api && npm run build`
2. Tests pass: `cd apps/api && npm run test`
3. Search logic includes amount condition when search term is numeric
4. Non-numeric searches work unchanged (description/notes matching)
</verification>

<success_criteria>
- [ ] Transactions service includes amount in search OR conditions
- [ ] Numeric search terms match exact amounts
- [ ] Non-numeric searches continue to work for description/notes
- [ ] All existing tests pass
- [ ] Phase must-have #3 is satisfied: "Search filters by amount, matching exact or partial values"
</success_criteria>

<output>
After completion, create `.planning/phases/06-search-functionality/06-03-SUMMARY.md`
</output>
