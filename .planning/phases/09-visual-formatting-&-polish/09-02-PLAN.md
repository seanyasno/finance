---
phase: 09-visual-formatting-and-polish
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - apps/finance/finance/Views/Transactions/TransactionRowView.swift
  - apps/finance/finance/Views/Transactions/TransactionDetailView.swift
  - apps/finance/finance/Views/Transactions/TransactionFilterView.swift
  - apps/finance/finance/Views/Transactions/TransactionListView.swift
  - apps/finance/finance/Views/BillingCycles/BillingCycleView.swift
  - apps/finance/finance/Views/CreditCards/CreditCardSettingsView.swift
autonomous: true

must_haves:
  truths:
    - "Pending transactions show clock icon indicator in transaction list"
    - "User can visually distinguish pending from settled transactions at a glance"
    - "Card format 'CardName 1234' is consistent across all views"
    - "When grouped by card, transaction rows hide redundant card display"
    - "When grouped by date or month, transaction rows show card information"
    - "Visual formatting works correctly across all three grouping modes"
  artifacts:
    - path: "apps/finance/finance/Views/Transactions/TransactionRowView.swift"
      provides: "Transaction row with pending indicator and conditional card display"
      contains: "isPending"
    - path: "apps/finance/finance/Views/Transactions/TransactionDetailView.swift"
      provides: "Transaction detail with pending status indicator"
      contains: "CardLabel"
  key_links:
    - from: "TransactionListView.swift"
      to: "TransactionRowView.swift"
      via: "showCard parameter based on groupingMode"
      pattern: "showCard:.*groupingMode"
    - from: "TransactionRowView.swift"
      to: "CardLabel.swift"
      via: "CardLabel component usage"
      pattern: "CardLabel\\("
---

<objective>
Integrate pending transaction indicators and CardLabel component across all views, with conditional card display when grouped by card.

Purpose: Complete visual polish for transactions with clear pending/settled distinction and consistent card formatting.
Output: Updated views with pending indicators and CardLabel integration.
</objective>

<execution_context>
@/Users/seanyasno/.claude/get-shit-done/workflows/execute-plan.md
@/Users/seanyasno/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-visual-formatting-&-polish/09-CONTEXT.md
@.planning/phases/09-visual-formatting-&-polish/09-01-SUMMARY.md
@apps/finance/finance/Views/Transactions/TransactionRowView.swift
@apps/finance/finance/Views/Transactions/TransactionDetailView.swift
@apps/finance/finance/Views/Transactions/TransactionFilterView.swift
@apps/finance/finance/Views/Transactions/TransactionListView.swift
@apps/finance/finance/Views/BillingCycles/BillingCycleView.swift
@apps/finance/finance/Views/CreditCards/CreditCardSettingsView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update TransactionRowView with pending indicator and conditional card display</name>
  <files>apps/finance/finance/Views/Transactions/TransactionRowView.swift</files>
  <action>
Update TransactionRowView to show pending indicator and conditionally hide card when grouped by card:

1. Add new stored property with default value for card visibility:
   ```swift
   let showCard: Bool

   init(transaction: Transaction, showCard: Bool = true) {
       self.transaction = transaction
       self.showCard = showCard
   }
   ```
   This provides backward compatibility - existing call sites with just `TransactionRowView(transaction: tx)` continue working.

2. Add pending indicator next to amount:
   - Use SF Symbol `clock.fill` for pending status (suggests "waiting/in progress")
   - Place BEFORE the amount in HStack for natural reading order
   - Use `.foregroundColor(.orange)` for visibility without being alarming
   - Use `.font(.caption)` to keep it subtle
   - Only show when `transaction.isPending`

3. Update card display section:
   - Wrap the card display in `if showCard { ... }`
   - Replace `Text("****\(card.cardNumber.suffix(4))")` with `CardLabel(card: card)`
   - This ensures consistent formatting across views

4. Consider slight visual de-emphasis for pending rows (optional):
   - Could use `.opacity(0.8)` on the entire row for pending transactions
   - Claude's discretion based on visual impact

5. Update Preview to include both pending and completed examples

The updated HStack for amount should look like:
```swift
HStack(spacing: 4) {
    if transaction.isPending {
        Image(systemName: "clock.fill")
            .font(.caption)
            .foregroundColor(.orange)
    }
    Text(transaction.formattedAmount)
        .font(.body)
        .fontWeight(.medium)
}
```
  </action>
  <verify>Build iOS app; preview shows pending indicator; card visibility respects showCard parameter</verify>
  <done>TransactionRowView shows clock icon for pending transactions and conditionally hides card when grouped by card</done>
</task>

<task type="auto">
  <name>Task 2: Update TransactionListView to pass grouping mode to rows</name>
  <files>apps/finance/finance/Views/Transactions/TransactionListView.swift</files>
  <action>
Update TransactionListView to pass showCard parameter based on grouping mode:

1. Locate the NavigationLink label closure at approximately lines 72-74 where TransactionRowView is created:
   ```swift
   // Current code (line 72-74):
   } label: {
       TransactionRowView(transaction: transaction)
   }
   ```

2. Update to pass showCard parameter:
   ```swift
   } label: {
       TransactionRowView(
           transaction: transaction,
           showCard: groupingMode != .creditCard
       )
   }
   ```

3. When groupingMode is .creditCard, showCard will be false, hiding redundant card info in rows
4. For .date and .month modes, showCard remains true (the default)

This ensures transaction rows don't redundantly show card info when the section header already identifies the card.
  </action>
  <verify>Build iOS app; switch between grouping modes; verify card info hidden only in card grouping mode</verify>
  <done>TransactionListView passes showCard=false when groupingMode is .creditCard, true otherwise</done>
</task>

<task type="auto">
  <name>Task 3: Update TransactionDetailView with pending indicator and CardLabel</name>
  <files>apps/finance/finance/Views/Transactions/TransactionDetailView.swift</files>
  <action>
Update TransactionDetailView with pending indicator and CardLabel component:

1. Update card display to use CardLabel:
   - Replace `LabeledContent("Card", value: "****\(card.cardNumber.suffix(4))")` with:
   ```swift
   if let card = transaction.creditCard {
       HStack {
           Text("Card")
           Spacer()
           CardLabel(card: card)
               .foregroundColor(.secondary)
       }
   }
   ```

2. Enhance Status row for pending transactions:
   - Add clock icon inline with status text for pending transactions:
   ```swift
   HStack {
       Text("Status")
       Spacer()
       if transaction.isPending {
           HStack(spacing: 4) {
               Image(systemName: "clock.fill")
                   .foregroundColor(.orange)
               Text("Pending")
                   .foregroundColor(.secondary)
           }
       } else {
           Text("Completed")
               .foregroundColor(.secondary)
       }
   }
   ```

3. Update Preview with pending transaction example
  </action>
  <verify>Build iOS app; detail view shows CardLabel format and pending indicator on Status row</verify>
  <done>TransactionDetailView uses CardLabel and shows clock icon with "Pending" status for pending transactions</done>
</task>

<task type="auto">
  <name>Task 4: Update remaining views to use new card format</name>
  <files>
    apps/finance/finance/Views/Transactions/TransactionFilterView.swift
    apps/finance/finance/Views/BillingCycles/BillingCycleView.swift
    apps/finance/finance/Views/CreditCards/CreditCardSettingsView.swift
  </files>
  <action>
Update remaining views to use the new card format via CardLabel or updated displayName:

1. **TransactionFilterView.swift**:
   - Update card picker Text to use CardLabel or the new displayName format:
   ```swift
   ForEach(creditCards) { card in
       Text(card.displayName)  // Already uses new format from Plan 01
           .tag(card.id as String?)
   }
   ```
   - Remove the old `"****\(card.cardNumber.suffix(4)) (\(card.company))"` format

2. **BillingCycleView.swift**:
   - The card picker already uses `card.displayName` which was updated in Plan 01
   - Verify it renders correctly with the new format
   - No changes needed if already using displayName

3. **CreditCardSettingsView.swift**:
   - Already uses `card.displayName` in the Card row
   - Verify it renders correctly with the new format
   - No changes needed if already using displayName

For each file, search for patterns like:
- `****\(` or `"****"` - Old asterisk format
- `suffix(4)` with adjacent asterisks - Old format usage

Replace with either `CardLabel(card:)` or rely on updated `displayName`.
  </action>
  <verify>Build iOS app; check filter sheet, billing cycle picker, and card settings all show "CardName 1234" format</verify>
  <done>All card displays across the app use consistent "CardName 1234" format</done>
</task>

</tasks>

<verification>
1. `xcodebuild -workspace apps/finance/finance.xcworkspace -scheme finance -destination 'platform=iOS Simulator,name=iPhone 15' build` succeeds
2. Manual verification checklist:
   - [ ] Transaction list shows clock icon for pending transactions
   - [ ] Clock icon appears before amount, in orange color
   - [ ] When grouped by card, transaction rows don't show card info
   - [ ] When grouped by date/month, transaction rows show card with new format
   - [ ] Transaction detail shows CardLabel format for card
   - [ ] Transaction detail shows clock icon + "Pending" for pending status
   - [ ] Filter sheet shows "CardName 1234" format in picker
   - [ ] Billing cycle card picker shows "CardName 1234" format
   - [ ] Card settings shows "CardName 1234" format
   - [ ] No asterisks (****) appear anywhere in card displays
</verification>

<success_criteria>
- Pending transactions have visible clock icon indicator in list and detail views
- Card format "CardName 1234" (with monospace digits where using CardLabel) is consistent everywhere
- Card info hidden in transaction rows when grouped by card (section header is sufficient)
- All three grouping modes work correctly with new formatting
- iOS app builds and runs without errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-visual-formatting-&-polish/09-02-SUMMARY.md`
</output>
