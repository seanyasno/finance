---
phase: 04-billing-cycles
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - apps/finance/finance/Models/CreditCard.swift
  - apps/finance/finance/Services/TransactionService.swift
  - apps/finance/finance/Views/CreditCards/CreditCardSettingsView.swift
  - apps/finance/finance/Views/HomeView.swift
autonomous: true

must_haves:
  truths:
    - "CreditCard model includes billingCycleStartDay property"
    - "User can view and edit billing cycle start day for each card"
    - "Number picker allows selection from 1-31"
    - "Settings view shows warning about historical regrouping when editing"
  artifacts:
    - path: "apps/finance/finance/Models/CreditCard.swift"
      provides: "CreditCard with billingCycleStartDay"
      contains: "billingCycleStartDay"
    - path: "apps/finance/finance/Views/CreditCards/CreditCardSettingsView.swift"
      provides: "Credit card settings with billing cycle picker"
      contains: "billingCycleStartDay"
  key_links:
    - from: "apps/finance/finance/Views/CreditCards/CreditCardSettingsView.swift"
      to: "/credit-cards/:id"
      via: "TransactionService.updateCreditCard"
      pattern: "patch.*credit-cards"
---

<objective>
Add iOS credit card settings with billing cycle configuration

Purpose: Enable users to configure the billing cycle start day for each credit card from within the iOS app, with clear feedback about how this affects spending period calculations.

Output: CreditCard model updated, TransactionService has update method, CreditCardSettingsView with number picker for billing cycle day.
</objective>

<execution_context>
@/Users/seanyasno/.claude/get-shit-done/workflows/execute-plan.md
@/Users/seanyasno/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-billing-cycles/04-CONTEXT.md
@.planning/phases/04-billing-cycles/04-01-SUMMARY.md

# Existing iOS models and services
@apps/finance/finance/Models/CreditCard.swift
@apps/finance/finance/Services/TransactionService.swift
@apps/finance/finance/Views/HomeView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update CreditCard model and add update method to TransactionService</name>
  <files>
apps/finance/finance/Models/CreditCard.swift
apps/finance/finance/Services/TransactionService.swift
  </files>
  <action>
1. Update CreditCard.swift to include billingCycleStartDay:
   ```swift
   struct CreditCard: Codable, Identifiable, Hashable {
       let id: String
       let cardNumber: String
       let company: String
       let billingCycleStartDay: Int?
       let createdAt: String?

       enum CodingKeys: String, CodingKey {
           case id
           case cardNumber
           case company
           case billingCycleStartDay
           case createdAt
       }

       /// Returns the effective billing cycle start day (defaults to 1 if not set)
       var effectiveBillingCycleDay: Int {
           billingCycleStartDay ?? 1
       }

       /// Display name for the credit card (last 4 digits)
       var displayName: String {
           let last4 = String(cardNumber.suffix(4))
           return "\(company.capitalized) ****\(last4)"
       }
   }
   ```

2. Add UpdateCreditCardRequest struct and updateCreditCard method to TransactionService.swift:
   ```swift
   // Add near top with other request structs
   struct UpdateCreditCardRequest: Codable {
       let billingCycleStartDay: Int?
   }

   // Add method to TransactionService class
   func updateCreditCard(id: String, billingCycleStartDay: Int?) async -> CreditCard? {
       let request = UpdateCreditCardRequest(billingCycleStartDay: billingCycleStartDay)

       do {
           let updated: CreditCard = try await apiService.patch("/credit-cards/\(id)", body: request)
           // Update local array
           if let index = creditCards.firstIndex(where: { $0.id == id }) {
               creditCards[index] = updated
           }
           return updated
       } catch let apiError as APIError {
           handleAPIError(apiError)
           return nil
       } catch {
           self.error = "An unexpected error occurred: \(error.localizedDescription)"
           return nil
       }
   }
   ```
  </action>
  <verify>
Build the iOS project in Xcode - should compile without errors.
  </verify>
  <done>
CreditCard model includes billingCycleStartDay and effectiveBillingCycleDay computed property.
TransactionService.updateCreditCard method can PATCH billing cycle configuration.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CreditCardSettingsView with billing cycle picker</name>
  <files>
apps/finance/finance/Views/CreditCards/CreditCardSettingsView.swift
apps/finance/finance/Views/HomeView.swift
  </files>
  <action>
1. Create CreditCards folder if needed, then create CreditCardSettingsView.swift:
   ```swift
   //
   //  CreditCardSettingsView.swift
   //  finance
   //

   import SwiftUI

   struct CreditCardSettingsView: View {
       @ObservedObject var transactionService: TransactionService
       @Environment(\.dismiss) private var dismiss

       @State private var selectedDay: Int = 1
       @State private var isSaving = false
       @State private var showingWarning = false

       let card: CreditCard

       var body: some View {
           Form {
               Section {
                   HStack {
                       Text("Card")
                       Spacer()
                       Text(card.displayName)
                           .foregroundColor(.secondary)
                   }
               }

               Section {
                   Picker("Billing Cycle Starts On", selection: $selectedDay) {
                       ForEach(1...31, id: \.self) { day in
                           Text(dayLabel(day)).tag(day)
                       }
                   }
                   .pickerStyle(.menu)
               } header: {
                   Text("Billing Cycle")
               } footer: {
                   Text("The day of the month when your billing cycle starts. Transactions will be grouped into periods starting on this day.")
               }

               Section {
                   Button {
                       showingWarning = true
                   } label: {
                       if isSaving {
                           HStack {
                               ProgressView()
                                   .progressViewStyle(CircularProgressViewStyle())
                               Text("Saving...")
                           }
                       } else {
                           Text("Save Changes")
                       }
                   }
                   .disabled(isSaving || selectedDay == card.effectiveBillingCycleDay)
               }
           }
           .navigationTitle("Card Settings")
           .navigationBarTitleDisplayMode(.inline)
           .onAppear {
               selectedDay = card.effectiveBillingCycleDay
           }
           .alert("Update Billing Cycle?", isPresented: $showingWarning) {
               Button("Cancel", role: .cancel) { }
               Button("Update") {
                   saveChanges()
               }
           } message: {
               Text("Changing the billing cycle start day will affect how your historical spending is grouped into periods. Past transactions may appear in different billing cycles.")
           }
       }

       private func dayLabel(_ day: Int) -> String {
           let suffix: String
           switch day {
           case 1, 21, 31: suffix = "st"
           case 2, 22: suffix = "nd"
           case 3, 23: suffix = "rd"
           default: suffix = "th"
           }
           return "\(day)\(suffix)"
       }

       private func saveChanges() {
           isSaving = true
           Task {
               let newDay = selectedDay == 1 ? nil : selectedDay  // null means default (1st)
               if await transactionService.updateCreditCard(id: card.id, billingCycleStartDay: newDay) != nil {
                   dismiss()
               }
               isSaving = false
           }
       }
   }

   #Preview {
       NavigationStack {
           CreditCardSettingsView(
               transactionService: TransactionService(),
               card: CreditCard(
                   id: "1",
                   cardNumber: "1234567890123456",
                   company: "max",
                   billingCycleStartDay: nil,
                   createdAt: nil
               )
           )
       }
   }
   ```

2. Add a "Credit Cards" tab to HomeView.swift with a list of cards that navigate to settings:
   - Add a new tab after the "Categories" tab
   - Create a simple CreditCardListView inline or as part of the same file

   In HomeView.swift, add a fourth tab:
   ```swift
   NavigationStack {
       CreditCardListView(transactionService: transactionService)
           .toolbar {
               ToolbarItem(placement: .navigationBarTrailing) {
                   Button("Logout") {
                       Task {
                           await authManager.logout()
                       }
                   }
               }
           }
   }
   .tabItem {
       Label("Cards", systemImage: "creditcard")
   }
   ```

   Add CreditCardListView as a separate view in the same file or new file:
   ```swift
   struct CreditCardListView: View {
       @StateObject private var transactionService = TransactionService()

       var body: some View {
           Group {
               if transactionService.isLoading {
                   ProgressView("Loading cards...")
               } else if transactionService.creditCards.isEmpty {
                   ContentUnavailableView(
                       "No Credit Cards",
                       systemImage: "creditcard",
                       description: Text("Your credit cards will appear here")
                   )
               } else {
                   List(transactionService.creditCards) { card in
                       NavigationLink {
                           CreditCardSettingsView(
                               transactionService: transactionService,
                               card: card
                           )
                       } label: {
                           CreditCardRowView(card: card)
                       }
                   }
                   .refreshable {
                       await transactionService.fetchCreditCards()
                   }
               }
           }
           .navigationTitle("Credit Cards")
           .task {
               await transactionService.fetchCreditCards()
           }
       }
   }

   struct CreditCardRowView: View {
       let card: CreditCard

       var body: some View {
           VStack(alignment: .leading, spacing: 4) {
               Text(card.displayName)
                   .font(.headline)
               HStack {
                   Text("Billing cycle: \(dayLabel(card.effectiveBillingCycleDay)) of month")
                       .font(.caption)
                       .foregroundColor(.secondary)
               }
           }
           .padding(.vertical, 4)
       }

       private func dayLabel(_ day: Int) -> String {
           let suffix: String
           switch day {
           case 1, 21, 31: suffix = "st"
           case 2, 22: suffix = "nd"
           case 3, 23: suffix = "rd"
           default: suffix = "th"
           }
           return "\(day)\(suffix)"
       }
   }
   ```
  </action>
  <verify>
1. Build iOS project in Xcode - should compile without errors
2. Run app - should see 4 tabs: Transactions, Spending, Categories, Cards
3. Navigate to Cards tab - should show list of credit cards
4. Tap a card - should show settings with billing cycle picker
  </verify>
  <done>
CreditCardSettingsView allows editing billing cycle start day with number picker (1-31).
Warning alert appears when saving changes.
Credit Cards tab in HomeView shows all cards with navigation to settings.
  </done>
</task>

</tasks>

<verification>
1. iOS Build: Project compiles without errors in Xcode
2. Model: CreditCard has billingCycleStartDay property and effectiveBillingCycleDay computed property
3. Service: TransactionService.updateCreditCard method exists and works
4. UI: Cards tab appears in TabView, shows card list, navigates to settings
5. Picker: Settings view has picker with days 1-31, shows warning on save
</verification>

<success_criteria>
- CreditCard model includes billingCycleStartDay with default computed property
- TransactionService can update credit card billing cycle via PATCH
- Credit Cards tab visible in main navigation
- User can view and edit billing cycle for each card
- Warning displayed when changing billing cycle
</success_criteria>

<output>
After completion, create `.planning/phases/04-billing-cycles/04-02-SUMMARY.md`
</output>
