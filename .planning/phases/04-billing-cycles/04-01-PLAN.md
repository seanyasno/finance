---
phase: 04-billing-cycles
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/database/prisma/schema.prisma
  - apps/api/src/credit-cards/dto/credit-card.dto.ts
  - apps/api/src/credit-cards/credit-cards.service.ts
  - apps/api/src/credit-cards/credit-cards.controller.ts
autonomous: true

must_haves:
  truths:
    - "API returns billingCycleStartDay for each credit card"
    - "PATCH /credit-cards/:id updates billing cycle start day"
    - "Cards without explicit setting return null for billingCycleStartDay"
  artifacts:
    - path: "packages/database/prisma/schema.prisma"
      provides: "billing_cycle_start_day column on credit_cards"
      contains: "billing_cycle_start_day"
    - path: "apps/api/src/credit-cards/dto/credit-card.dto.ts"
      provides: "UpdateCreditCardDto with billingCycleStartDay"
      contains: "UpdateCreditCardDto"
    - path: "apps/api/src/credit-cards/credit-cards.controller.ts"
      provides: "PATCH endpoint for credit card updates"
      contains: "@Patch"
  key_links:
    - from: "apps/api/src/credit-cards/credit-cards.controller.ts"
      to: "prisma.credit_cards.update"
      via: "CreditCardsService.update"
      pattern: "update.*billing_cycle_start_day"
---

<objective>
Add billing cycle configuration to credit cards API

Purpose: Enable users to configure when their credit card billing cycle starts (day of month 1-31) for accurate billing period calculations.

Output: Database schema updated with billing_cycle_start_day field, GET returns it, PATCH endpoint allows updating it.
</objective>

<execution_context>
@/Users/seanyasno/.claude/get-shit-done/workflows/execute-plan.md
@/Users/seanyasno/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-billing-cycles/04-CONTEXT.md

# Existing credit cards implementation
@packages/database/prisma/schema.prisma
@apps/api/src/credit-cards/dto/credit-card.dto.ts
@apps/api/src/credit-cards/credit-cards.service.ts
@apps/api/src/credit-cards/credit-cards.controller.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add billing_cycle_start_day to database schema</name>
  <files>packages/database/prisma/schema.prisma</files>
  <action>
Add billing_cycle_start_day field to the credit_cards model:

```prisma
model credit_cards {
  // ... existing fields ...
  billing_cycle_start_day Int?  // Day of month (1-31), null means default to 1st
  // ... rest of model ...
}
```

After updating schema:
1. Run `cd packages/database && npx prisma db push` to apply migration
2. Run `cd packages/database && npx prisma generate` to regenerate client

The field is nullable because existing cards won't have a value, and null will mean "use default (1st of month)" in the iOS app.
  </action>
  <verify>
Run `npx prisma db push --preview-feature` in packages/database - should complete without errors.
Run `npx prisma generate` - should complete without errors.
  </verify>
  <done>
credit_cards table has billing_cycle_start_day column accepting integers 1-31 or null.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update DTOs and add PATCH endpoint</name>
  <files>
apps/api/src/credit-cards/dto/credit-card.dto.ts
apps/api/src/credit-cards/credit-cards.service.ts
apps/api/src/credit-cards/credit-cards.controller.ts
  </files>
  <action>
1. Update CreditCardSchema in dto/credit-card.dto.ts:
   - Add `billingCycleStartDay: z.number().int().min(1).max(31).nullable()` to existing schema

2. Create UpdateCreditCardDto in dto/credit-card.dto.ts:
   ```typescript
   export const UpdateCreditCardSchema = z.object({
     billingCycleStartDay: z.number().int().min(1).max(31).nullable(),
   });

   export class UpdateCreditCardDto extends createZodDto(UpdateCreditCardSchema) {}
   ```

3. Add update method to CreditCardsService:
   ```typescript
   async update(userId: string, cardId: string, data: { billingCycleStartDay: number | null }) {
     // First verify card belongs to user
     const card = await this.prisma.credit_cards.findFirst({
       where: { id: cardId, user_id: userId },
     });

     if (!card) {
       throw new NotFoundException('Credit card not found');
     }

     const updated = await this.prisma.credit_cards.update({
       where: { id: cardId },
       data: { billing_cycle_start_day: data.billingCycleStartDay },
     });

     return {
       id: updated.id,
       cardNumber: updated.card_number,
       company: updated.company,
       billingCycleStartDay: updated.billing_cycle_start_day,
       createdAt: updated.created_at,
     };
   }
   ```

4. Update findAll in CreditCardsService to return billingCycleStartDay:
   ```typescript
   return creditCards.map((card) => ({
     id: card.id,
     cardNumber: card.card_number,
     company: card.company,
     billingCycleStartDay: card.billing_cycle_start_day,
     createdAt: card.created_at,
   }));
   ```

5. Add PATCH endpoint to CreditCardsController:
   ```typescript
   @Patch(':id')
   @UseGuards(JwtAuthGuard)
   @ApiBearerAuth()
   @ApiOperation({ summary: 'Update credit card billing cycle configuration' })
   @ApiResponse({
     status: HttpStatus.OK,
     description: 'Credit card updated successfully',
     type: CreditCardDto,
   })
   @ApiResponse({
     status: HttpStatus.NOT_FOUND,
     description: 'Credit card not found',
   })
   async update(
     @CurrentUser() user: AuthUser,
     @Param('id') id: string,
     @Body() updateDto: UpdateCreditCardDto,
   ): Promise<CreditCardDto> {
     return this.creditCardsService.update(user.id, id, updateDto);
   }
   ```

Import NotFoundException from @nestjs/common, Param and Body decorators.
  </action>
  <verify>
1. Run `cd apps/api && npm run build` - should compile without errors
2. Run `cd apps/api && npm run start:dev` - server should start
3. Check Swagger at http://localhost:3000/api - should show PATCH /credit-cards/:id endpoint
  </verify>
  <done>
GET /credit-cards returns billingCycleStartDay for each card.
PATCH /credit-cards/:id accepts { billingCycleStartDay: number | null } and updates the card.
Validation rejects values outside 1-31 range.
  </done>
</task>

</tasks>

<verification>
1. Database: `SELECT billing_cycle_start_day FROM credit_cards LIMIT 1` runs without error
2. API Build: `cd apps/api && npm run build` completes successfully
3. Swagger: PATCH /credit-cards/{id} endpoint documented with UpdateCreditCardDto schema
4. GET Response: Credit card objects include billingCycleStartDay field (null for existing cards)
</verification>

<success_criteria>
- billing_cycle_start_day column exists in credit_cards table
- GET /credit-cards returns billingCycleStartDay for each card
- PATCH /credit-cards/:id updates billingCycleStartDay with validation (1-31 or null)
- API builds and runs without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-billing-cycles/04-01-SUMMARY.md`
</output>
