---
phase: 05-statistics-and-analytics
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - apps/finance/finance/Services/StatisticsService.swift
  - apps/finance/finance/Views/Statistics/SpendingChartView.swift
  - apps/finance/finance/Views/Statistics/MonthComparisonView.swift
  - apps/finance/finance/Views/Statistics/TrendIndicatorView.swift
  - apps/finance/finance/Views/Statistics/StatisticsView.swift
  - apps/finance/finance/Views/HomeView.swift
autonomous: true

must_haves:
  truths:
    - "User can see 5-month bar chart of spending history"
    - "User can tap a bar to see category breakdown for that month"
    - "User can see comparison between current and previous month with color indicators"
    - "User can see trend arrows showing spending direction"
  artifacts:
    - path: "apps/finance/finance/Services/StatisticsService.swift"
      provides: "API client for statistics endpoint"
      exports: ["StatisticsService"]
    - path: "apps/finance/finance/Views/Statistics/SpendingChartView.swift"
      provides: "5-month bar chart visualization"
      min_lines: 80
    - path: "apps/finance/finance/Views/Statistics/StatisticsView.swift"
      provides: "Main statistics tab view"
      min_lines: 50
  key_links:
    - from: "apps/finance/finance/Views/Statistics/StatisticsView.swift"
      to: "apps/finance/finance/Services/StatisticsService.swift"
      via: "StateObject initialization"
      pattern: "@StateObject.*StatisticsService"
    - from: "apps/finance/finance/Views/HomeView.swift"
      to: "apps/finance/finance/Views/Statistics/StatisticsView.swift"
      via: "TabView tab item"
      pattern: "StatisticsView"
---

<objective>
Create iOS Statistics UI with 5-month bar chart, month comparison, and trend indicators.

Purpose: Enable users to visualize spending patterns over time, understand month-over-month changes, and identify spending trends by category.

Output: New Statistics tab with interactive chart, comparison view, and trend indicators using data from statistics API.
</objective>

<execution_context>
@/Users/seanyasno/.claude/get-shit-done/workflows/execute-plan.md
@/Users/seanyasno/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-statistics-and-analytics/05-CONTEXT.md
@.planning/phases/05-statistics-and-analytics/05-02-SUMMARY.md
@apps/finance/finance/Services/APIService.swift
@apps/finance/finance/Views/HomeView.swift
@apps/finance/finance/Views/BillingCycles/BillingCycleSummaryView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create StatisticsService and model types</name>
  <files>
    apps/finance/finance/Services/StatisticsService.swift
  </files>
  <action>
1. Create `apps/finance/finance/Services/StatisticsService.swift`:

```swift
import Foundation

// MARK: - Response Models

struct CategorySpending: Codable, Identifiable {
    let categoryId: String?
    let categoryName: String
    let amount: Double
    let percentage: Int
    let transactionCount: Int

    var id: String { categoryId ?? "uncategorized" }
}

struct MonthlySpending: Codable, Identifiable {
    let month: String        // "2026-01" format
    let monthLabel: String   // "January 2026"
    let total: Double
    let categoryBreakdown: [CategorySpending]

    var id: String { month }

    var formattedTotal: String {
        String(format: "%.0f", total)
    }
}

struct CategoryComparison: Codable, Identifiable {
    let categoryId: String?
    let categoryName: String
    let currentAmount: Double
    let previousAmount: Double?
    let changeAmount: Double?
    let changePercent: Int?
    let trend: TrendDirection

    var id: String { categoryId ?? "uncategorized" }
}

struct MonthComparison: Codable {
    let currentMonth: String
    let previousMonth: String?
    let currentTotal: Double
    let previousTotal: Double?
    let changeAmount: Double?
    let changePercent: Int?
    let trend: TrendDirection
    let categoryComparisons: [CategoryComparison]
}

struct CategoryTrend: Codable, Identifiable {
    let categoryId: String?
    let categoryName: String
    let trend: TrendDirection
    let averageMonthly: Double
    let currentMonth: Double
    let changePercent: Int

    var id: String { categoryId ?? "uncategorized" }
}

struct SpendingTrends: Codable {
    let overall: TrendDirection
    let overallAverageMonthly: Double
    let categoryTrends: [CategoryTrend]
}

enum TrendDirection: String, Codable {
    case up
    case down
    case stable
}

struct SpendingSummary: Codable {
    let months: [MonthlySpending]
    let comparison: MonthComparison
    let trends: SpendingTrends
}

struct SpendingSummaryResponse: Codable {
    let summary: SpendingSummary
}

// MARK: - Statistics Service

@MainActor
class StatisticsService: ObservableObject {
    private let apiService: APIService

    @Published var summary: SpendingSummary?
    @Published var isLoading = false
    @Published var error: String?

    init(apiService: APIService = .shared) {
        self.apiService = apiService
    }

    func fetchSpendingSummary() async {
        isLoading = true
        error = nil

        do {
            let response: SpendingSummary = try await apiService.get(
                "/statistics/spending-summary",
                authenticated: true
            )
            summary = response
            isLoading = false
        } catch let apiError as APIError {
            handleAPIError(apiError)
        } catch {
            self.error = "An unexpected error occurred: \(error.localizedDescription)"
            isLoading = false
        }
    }

    private func handleAPIError(_ error: APIError) {
        switch error {
        case .invalidURL:
            self.error = "Invalid URL"
        case .networkError(let underlyingError):
            self.error = "Network error: \(underlyingError.localizedDescription)"
        case .invalidResponse:
            self.error = "Invalid response from server"
        case .httpError(let statusCode, let message):
            self.error = message ?? "HTTP error: \(statusCode)"
        case .decodingError(let underlyingError):
            self.error = "Failed to decode response: \(underlyingError.localizedDescription)"
        }
        isLoading = false
    }
}
```
  </action>
  <verify>
    - `cat apps/finance/finance/Services/StatisticsService.swift` shows service implementation
    - iOS project builds with new service
  </verify>
  <done>
    StatisticsService fetches spending summary from API with proper model types
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Statistics UI views</name>
  <files>
    apps/finance/finance/Views/Statistics/SpendingChartView.swift
    apps/finance/finance/Views/Statistics/MonthComparisonView.swift
    apps/finance/finance/Views/Statistics/TrendIndicatorView.swift
    apps/finance/finance/Views/Statistics/StatisticsView.swift
    apps/finance/finance/Views/HomeView.swift
  </files>
  <action>
1. Create folder: `apps/finance/finance/Views/Statistics/`

2. Create `TrendIndicatorView.swift`:
```swift
import SwiftUI

struct TrendIndicatorView: View {
    let trend: TrendDirection
    let showLabel: Bool

    init(trend: TrendDirection, showLabel: Bool = false) {
        self.trend = trend
        self.showLabel = showLabel
    }

    var body: some View {
        HStack(spacing: 4) {
            Image(systemName: iconName)
                .foregroundColor(color)
            if showLabel {
                Text(label)
                    .font(.caption)
                    .foregroundColor(color)
            }
        }
    }

    private var iconName: String {
        switch trend {
        case .up: return "arrow.up"
        case .down: return "arrow.down"
        case .stable: return "arrow.forward"
        }
    }

    private var color: Color {
        switch trend {
        // Red for spending increase (bad), green for decrease (good)
        case .up: return .red
        case .down: return .green
        case .stable: return .secondary
        }
    }

    private var label: String {
        switch trend {
        case .up: return "Increasing"
        case .down: return "Decreasing"
        case .stable: return "Stable"
        }
    }
}
```

3. Create `SpendingChartView.swift`:
```swift
import SwiftUI

struct SpendingChartView: View {
    let months: [MonthlySpending]
    @Binding var selectedMonth: MonthlySpending?

    private var maxTotal: Double {
        months.map { $0.total }.max() ?? 1
    }

    var body: some View {
        VStack(spacing: 8) {
            // Bar chart
            HStack(alignment: .bottom, spacing: 12) {
                ForEach(months) { month in
                    VStack {
                        // Amount label
                        Text(formatAmount(month.total))
                            .font(.caption2)
                            .foregroundColor(.secondary)
                            .lineLimit(1)
                            .minimumScaleFactor(0.5)

                        // Bar
                        RoundedRectangle(cornerRadius: 4)
                            .fill(barColor(for: month))
                            .frame(height: barHeight(for: month))
                            .frame(maxWidth: .infinity)
                            .onTapGesture {
                                withAnimation {
                                    selectedMonth = selectedMonth?.id == month.id ? nil : month
                                }
                            }

                        // Month label
                        Text(shortMonthLabel(month))
                            .font(.caption)
                            .foregroundColor(.primary)
                    }
                }
            }
            .frame(height: 180)
            .padding(.horizontal)

            // Selected month breakdown
            if let selected = selectedMonth {
                VStack(alignment: .leading, spacing: 8) {
                    HStack {
                        Text(selected.monthLabel)
                            .font(.headline)
                        Spacer()
                        Text(formatAmount(selected.total))
                            .font(.headline)
                    }

                    Divider()

                    ForEach(selected.categoryBreakdown) { category in
                        HStack {
                            Text(category.categoryName)
                            Spacer()
                            Text("\(category.percentage)%")
                                .foregroundColor(.secondary)
                            Text(formatAmount(category.amount))
                        }
                        .font(.subheadline)
                    }
                }
                .padding()
                .background(Color(.systemGray6))
                .cornerRadius(12)
                .padding(.horizontal)
            }
        }
    }

    private func barHeight(for month: MonthlySpending) -> CGFloat {
        guard maxTotal > 0 else { return 0 }
        let proportion = month.total / maxTotal
        return max(CGFloat(proportion) * 120, month.total > 0 ? 4 : 0)
    }

    private func barColor(for month: MonthlySpending) -> Color {
        if selectedMonth?.id == month.id {
            return .blue
        }
        return .blue.opacity(0.7)
    }

    private func shortMonthLabel(_ month: MonthlySpending) -> String {
        // Extract short month name from "January 2026" -> "Jan"
        let components = month.monthLabel.split(separator: " ")
        if let monthName = components.first {
            return String(monthName.prefix(3))
        }
        return month.month
    }

    private func formatAmount(_ amount: Double) -> String {
        if amount >= 1000 {
            return String(format: "%.1fK", amount / 1000)
        }
        return String(format: "%.0f", amount)
    }
}
```

4. Create `MonthComparisonView.swift`:
```swift
import SwiftUI

struct MonthComparisonView: View {
    let comparison: MonthComparison

    var body: some View {
        VStack(alignment: .leading, spacing: 16) {
            // Overall comparison header
            HStack {
                VStack(alignment: .leading) {
                    Text("vs Previous Month")
                        .font(.subheadline)
                        .foregroundColor(.secondary)

                    if let changePercent = comparison.changePercent,
                       let changeAmount = comparison.changeAmount {
                        HStack(spacing: 8) {
                            TrendIndicatorView(trend: comparison.trend)

                            Text(formatChange(changeAmount, percent: changePercent))
                                .font(.title2)
                                .fontWeight(.semibold)
                                .foregroundColor(changeColor)
                        }
                    } else {
                        Text("No previous data")
                            .font(.title3)
                            .foregroundColor(.secondary)
                    }
                }

                Spacer()

                VStack(alignment: .trailing) {
                    Text("This Month")
                        .font(.caption)
                        .foregroundColor(.secondary)
                    Text(formatAmount(comparison.currentTotal))
                        .font(.title3)
                        .fontWeight(.medium)
                }
            }
            .padding()
            .background(Color(.systemGray6))
            .cornerRadius(12)

            // Category comparisons
            if !comparison.categoryComparisons.isEmpty {
                VStack(alignment: .leading, spacing: 8) {
                    Text("By Category")
                        .font(.headline)

                    ForEach(comparison.categoryComparisons) { category in
                        HStack {
                            TrendIndicatorView(trend: category.trend)

                            Text(category.categoryName)

                            Spacer()

                            if let changePercent = category.changePercent {
                                Text("\(changePercent > 0 ? "+" : "")\(changePercent)%")
                                    .font(.caption)
                                    .foregroundColor(categoryChangeColor(category.trend))
                            }

                            Text(formatAmount(category.currentAmount))
                                .fontWeight(.medium)
                        }
                        .font(.subheadline)
                    }
                }
                .padding()
                .background(Color(.systemGray6))
                .cornerRadius(12)
            }
        }
    }

    private var changeColor: Color {
        switch comparison.trend {
        case .up: return .red
        case .down: return .green
        case .stable: return .secondary
        }
    }

    private func categoryChangeColor(_ trend: TrendDirection) -> Color {
        switch trend {
        case .up: return .red
        case .down: return .green
        case .stable: return .secondary
        }
    }

    private func formatChange(_ amount: Double, percent: Int) -> String {
        let sign = amount >= 0 ? "+" : ""
        return "\(sign)\(formatAmount(amount)) (\(sign)\(percent)%)"
    }

    private func formatAmount(_ amount: Double) -> String {
        String(format: "%.0f", abs(amount))
    }
}
```

5. Create `StatisticsView.swift`:
```swift
import SwiftUI

struct StatisticsView: View {
    @StateObject private var statisticsService = StatisticsService()
    @State private var selectedMonth: MonthlySpending?

    var body: some View {
        Group {
            if statisticsService.isLoading {
                ProgressView("Loading statistics...")
            } else if let error = statisticsService.error {
                ContentUnavailableView(
                    "Error Loading Statistics",
                    systemImage: "exclamationmark.triangle",
                    description: Text(error)
                )
            } else if let summary = statisticsService.summary {
                ScrollView {
                    VStack(spacing: 24) {
                        // Overall trend header
                        HStack {
                            VStack(alignment: .leading) {
                                Text("Spending Trend")
                                    .font(.headline)
                                Text("Last 5 Months")
                                    .font(.caption)
                                    .foregroundColor(.secondary)
                            }

                            Spacer()

                            TrendIndicatorView(trend: summary.trends.overall, showLabel: true)
                        }
                        .padding(.horizontal)

                        // 5-month bar chart
                        SpendingChartView(
                            months: summary.months,
                            selectedMonth: $selectedMonth
                        )

                        // Month comparison
                        MonthComparisonView(comparison: summary.comparison)
                            .padding(.horizontal)

                        // Category trends (if not showing month breakdown)
                        if selectedMonth == nil && !summary.trends.categoryTrends.isEmpty {
                            VStack(alignment: .leading, spacing: 8) {
                                Text("Category Trends")
                                    .font(.headline)
                                    .padding(.horizontal)

                                VStack(spacing: 8) {
                                    ForEach(summary.trends.categoryTrends) { trend in
                                        HStack {
                                            TrendIndicatorView(trend: trend.trend)

                                            Text(trend.categoryName)

                                            Spacer()

                                            VStack(alignment: .trailing) {
                                                Text(formatAmount(trend.currentMonth))
                                                    .fontWeight(.medium)
                                                Text("avg \(formatAmount(trend.averageMonthly))")
                                                    .font(.caption)
                                                    .foregroundColor(.secondary)
                                            }
                                        }
                                        .font(.subheadline)
                                    }
                                }
                                .padding()
                                .background(Color(.systemGray6))
                                .cornerRadius(12)
                                .padding(.horizontal)
                            }
                        }
                    }
                    .padding(.vertical)
                }
            } else {
                ContentUnavailableView(
                    "No Statistics",
                    systemImage: "chart.bar",
                    description: Text("Statistics will appear once you have transactions")
                )
            }
        }
        .navigationTitle("Statistics")
        .refreshable {
            await statisticsService.fetchSpendingSummary()
        }
        .task {
            await statisticsService.fetchSpendingSummary()
        }
    }

    private func formatAmount(_ amount: Double) -> String {
        String(format: "%.0f", amount)
    }
}

#Preview {
    NavigationStack {
        StatisticsView()
    }
}
```

6. Update `HomeView.swift`:
   - Add Statistics tab after Cycles tab:
   ```swift
   NavigationStack {
       StatisticsView()
           .toolbar {
               ToolbarItem(placement: .navigationBarTrailing) {
                   Button("Logout") {
                       Task {
                           await authManager.logout()
                       }
                   }
               }
           }
   }
   .tabItem {
       Label("Statistics", systemImage: "chart.bar")
   }
   ```
  </action>
  <verify>
    - All view files exist in apps/finance/finance/Views/Statistics/
    - iOS app builds: `cd apps/finance && xcodebuild -scheme finance -destination 'platform=iOS Simulator,name=iPhone 15' build 2>&1 | tail -20`
    - Statistics tab appears in HomeView tab bar
  </verify>
  <done>
    Statistics UI complete with 5-month chart, month comparison, and trend indicators accessible via new tab
  </done>
</task>

</tasks>

<verification>
1. iOS app builds without errors
2. Statistics tab visible in main navigation
3. Chart displays 5 months of bars with amounts
4. Tapping a bar shows category breakdown for that month
5. Comparison section shows red/green indicators based on spending change
6. Trend arrows display correctly for overall and per-category trends
</verification>

<success_criteria>
- STATS-03: 5-month bar chart visible and interactive
- STATS-04: Month comparison shows current vs previous with indicators
- STATS-05: Trend indicators (arrows + colors) throughout UI
- All UI follows iOS native patterns (SwiftUI, system colors)
</success_criteria>

<output>
After completion, create `.planning/phases/05-statistics-and-analytics/05-03-SUMMARY.md`
</output>
