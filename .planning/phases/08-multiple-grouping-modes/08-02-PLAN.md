---
phase: 08-multiple-grouping-modes
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - apps/finance/finance/Views/Transactions/TransactionListView.swift
autonomous: true

must_haves:
  truths:
    - "User can see grouping mode selector in transaction list"
    - "User can switch to date grouping and see transactions grouped by date"
    - "User can switch to card grouping and see transactions grouped by credit card"
    - "User can switch to month grouping and see transactions grouped by month"
    - "Selected grouping mode persists across app launches"
  artifacts:
    - path: "apps/finance/finance/Views/Transactions/TransactionListView.swift"
      provides: "Mode selector UI and grouping logic for all three modes"
      contains: "@AppStorage"
  key_links:
    - from: "TransactionListView"
      to: "GroupingMode"
      via: "@AppStorage selectedGroupingMode"
      pattern: "@AppStorage.*groupingMode"
    - from: "groupedTransactions computed property"
      to: "Transaction grouping keys"
      via: "switch on groupingMode"
      pattern: "switch.*groupingMode|case.*\\.date|case.*\\.creditCard|case.*\\.month"
---

<objective>
Add grouping mode selector and implement all three grouping strategies in TransactionListView.

Purpose: Let users switch between viewing transactions grouped by date, credit card, or month with their preference persisted.
Output: Mode selector in toolbar, three-way grouping logic, and persistent mode storage.
</objective>

<execution_context>
@/Users/seanyasno/.claude/get-shit-done/workflows/execute-plan.md
@/Users/seanyasno/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-multiple-grouping-modes/08-CONTEXT.md
@.planning/phases/08-multiple-grouping-modes/08-01-SUMMARY.md
@apps/finance/finance/Views/Transactions/TransactionListView.swift
@apps/finance/finance/Generated/CustomModels.swift
@apps/finance/finance/Generated/ModelExtensions.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add grouping mode selector to toolbar</name>
  <files>apps/finance/finance/Views/Transactions/TransactionListView.swift</files>
  <action>
Add @AppStorage property for persisting grouping mode:
- @AppStorage("transactionGroupingMode") private var groupingModeRaw: String = GroupingMode.date.rawValue
- Add computed property: var groupingMode: GroupingMode { GroupingMode(rawValue: groupingModeRaw) ?? .date }

Add a Menu in the toolbar (leading position) for mode selection:
- Use Label with icon and text from GroupingMode.iconName and GroupingMode.displayName
- Show checkmark next to currently selected mode
- On selection, update groupingModeRaw

Example pattern:
```swift
ToolbarItem(placement: .navigationBarLeading) {
    Menu {
        ForEach(GroupingMode.allCases, id: \.self) { mode in
            Button {
                groupingModeRaw = mode.rawValue
            } label: {
                if groupingMode == mode {
                    Label(mode.displayName, systemImage: "checkmark")
                } else {
                    Text(mode.displayName)
                }
            }
        }
    } label: {
        Label("Group by", systemImage: groupingMode.iconName)
    }
}
```

Decisions made:
- Menu in leading toolbar position (filter button stays in trailing)
- Menu label shows current mode icon
- Checkmark indicates selected mode
- Keep search/filters active when switching modes (no clearing)
  </action>
  <verify>
Build succeeds and UI renders without errors.
  </verify>
  <done>
Mode selector Menu appears in toolbar with all three options. Selection updates @AppStorage.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement three-way grouping logic</name>
  <files>apps/finance/finance/Views/Transactions/TransactionListView.swift</files>
  <action>
Replace the existing groupedTransactions computed property with a switch on groupingMode:

```swift
private var groupedTransactions: [(key: String, transactions: [Transaction], header: String)] {
    let transactions = transactionService.transactions

    switch groupingMode {
    case .date:
        let grouped = Dictionary(grouping: transactions) { $0.dateGroupingKey }
        return grouped.map { (key: $0.key, transactions: $0.value, header: $0.value.first?.sectionHeaderTitle ?? $0.key) }
            .sorted { $0.key > $1.key }

    case .creditCard:
        let grouped = Dictionary(grouping: transactions) { $0.cardGroupingKey }
        return grouped.map { (key: $0.key, transactions: $0.value.sorted { $0.date > $1.date }, header: $0.value.first?.cardSectionHeader ?? "Unknown Card") }
            .sorted { $0.key < $1.key }  // Alphabetical by card ID

    case .month:
        let grouped = Dictionary(grouping: transactions) { $0.monthGroupingKey }
        return grouped.map { (key: $0.key, transactions: $0.value.sorted { $0.date > $1.date }, header: $0.value.first?.monthSectionHeader ?? $0.key) }
            .sorted { $0.key > $1.key }  // Newest month first
    }
}
```

Update the List ForEach to use the new tuple structure:
- Use group.header for Section header text instead of firstTransaction.sectionHeaderTitle
- The header is now pre-computed for each grouping mode

Key points:
- Date grouping: unchanged behavior (Today/Yesterday/DD-MM-YY headers)
- Card grouping: groups by card ID, header shows card display name, transactions sorted by date within each card
- Month grouping: groups by YYYY-MM, header shows "February 2026" style, transactions sorted by date within each month
  </action>
  <verify>
Build iOS app: cd apps/finance && xcodebuild -scheme finance -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -20
Run app in simulator and verify:
1. Date mode shows Today/Yesterday/DD-MM-YY section headers
2. Card mode shows card names as section headers with transactions sorted by date
3. Month mode shows "Month Year" section headers with transactions sorted by date
4. Switching modes updates the list immediately
5. Kill and relaunch app - mode preference is remembered
  </verify>
  <done>
Three grouping modes fully functional. Date mode shows relative/formatted dates. Card mode groups by credit card with card name headers. Month mode groups by calendar month with "Month Year" headers. All modes persist selection across app launches.
  </done>
</task>

</tasks>

<verification>
- iOS build succeeds without errors
- Mode selector appears in toolbar leading position
- Tapping mode selector shows menu with Date, Card, Month options
- Current mode shows checkmark in menu
- Selecting Date groups transactions by day with Today/Yesterday/DD-MM-YY headers
- Selecting Card groups transactions by credit card with card name headers
- Selecting Month groups transactions by calendar month with "Month Year" headers
- Switching modes updates list immediately (no reload required)
- Closing and reopening app preserves selected mode
- Search and filters work correctly with all grouping modes
</verification>

<success_criteria>
- Build passes with no compiler errors
- All three grouping modes display correctly
- Mode selector is accessible and intuitive
- Mode preference persists via @AppStorage
- Requirements GROUP-04, GROUP-05, GROUP-06 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/08-multiple-grouping-modes/08-02-SUMMARY.md`
</output>
