---
phase: 03-categorization
plan: 05
type: execute
wave: 3
depends_on: ["03-03", "03-04"]
files_modified:
  - apps/finance/finance/Views/Categories/CategorySpendingView.swift
  - apps/finance/finance/Views/HomeView.swift
autonomous: false

must_haves:
  truths:
    - "User can view transactions grouped by category"
    - "User can see total spending per category"
    - "User can tap a category to see its transactions"
    - "Uncategorized transactions shown in separate group"
  artifacts:
    - path: "apps/finance/finance/Views/Categories/CategorySpendingView.swift"
      provides: "Category-grouped transaction view with spending totals"
      contains: "struct CategorySpendingView"
    - path: "apps/finance/finance/Views/HomeView.swift"
      provides: "Navigation to category spending view"
      contains: "CategorySpendingView"
  key_links:
    - from: "apps/finance/finance/Views/Categories/CategorySpendingView.swift"
      to: "TransactionService"
      via: "@StateObject for transaction data"
      pattern: "@StateObject.*TransactionService"
    - from: "apps/finance/finance/Views/HomeView.swift"
      to: "CategorySpendingView"
      via: "TabView or NavigationLink"
      pattern: "CategorySpendingView"
---

<objective>
Create category-grouped transaction view showing spending breakdown by category.

Purpose: Core value of categorization - understanding where money goes by viewing transactions organized by category.
Output: CategorySpendingView showing categories with spending totals, expandable to show transactions.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-categorization/03-03-SUMMARY.md (if exists)
@.planning/phases/03-categorization/03-04-SUMMARY.md (if exists)

Existing implementation:
@apps/finance/finance/Views/Transactions/TransactionListView.swift
@apps/finance/finance/Views/Transactions/TransactionRowView.swift
@apps/finance/finance/Views/HomeView.swift
@apps/finance/finance/Services/TransactionService.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Category Spending View</name>
  <files>
apps/finance/finance/Views/Categories/CategorySpendingView.swift
  </files>
  <action>
Create CategorySpendingView that shows transactions grouped by category with spending totals:

```swift
struct CategorySpendingView: View {
    @StateObject private var transactionService = TransactionService()
    @StateObject private var categoryService = CategoryService()

    var body: some View {
        Group {
            if transactionService.isLoading {
                ProgressView("Loading...")
            } else if let error = transactionService.error {
                // Error state with retry
            } else {
                List {
                    ForEach(groupedByCategory, id: \.category?.id ?? "uncategorized") { group in
                        Section {
                            DisclosureGroup {
                                ForEach(group.transactions) { transaction in
                                    NavigationLink {
                                        TransactionDetailView(
                                            transaction: transaction,
                                            transactionService: transactionService
                                        )
                                    } label: {
                                        TransactionRowView(transaction: transaction)
                                    }
                                }
                            } label: {
                                CategorySpendingRow(
                                    category: group.category,
                                    total: group.total,
                                    count: group.transactions.count
                                )
                            }
                        }
                    }
                }
                .refreshable {
                    await loadData()
                }
            }
        }
        .navigationTitle("Spending by Category")
        .task {
            await loadData()
        }
    }

    private struct CategoryGroup {
        let category: Category?
        let transactions: [Transaction]
        var total: Double {
            transactions.reduce(0) { $0 + $1.chargedAmount }
        }
    }

    private var groupedByCategory: [CategoryGroup] {
        let grouped = Dictionary(grouping: transactionService.transactions) { $0.categoryId }

        var result: [CategoryGroup] = []

        // Add categorized groups
        for (categoryId, transactions) in grouped {
            if let categoryId = categoryId,
               let category = categoryService.categories.first(where: { $0.id == categoryId }) {
                result.append(CategoryGroup(category: category, transactions: transactions))
            } else if categoryId == nil {
                // Uncategorized group handled separately
            }
        }

        // Sort by total spending (highest first)
        result.sort { $0.total > $1.total }

        // Add uncategorized at the end
        if let uncategorized = grouped[nil], !uncategorized.isEmpty {
            result.append(CategoryGroup(category: nil, transactions: uncategorized))
        }

        return result
    }

    private func loadData() async {
        await withTaskGroup(of: Void.self) { group in
            group.addTask { await transactionService.fetchTransactions() }
            group.addTask { await categoryService.fetchCategories() }
        }
    }
}
```

**CategorySpendingRow helper view:**
```swift
struct CategorySpendingRow: View {
    let category: Category?
    let total: Double
    let count: Int

    var body: some View {
        HStack {
            if let category = category {
                Image(systemName: category.displayIcon)
                    .foregroundColor(category.displayColor)
                    .frame(width: 30)
                Text(category.name)
            } else {
                Image(systemName: "questionmark.circle")
                    .foregroundColor(.secondary)
                    .frame(width: 30)
                Text("Uncategorized")
                    .foregroundColor(.secondary)
            }

            Spacer()

            VStack(alignment: .trailing) {
                Text(formattedTotal)
                    .font(.headline)
                Text("\(count) transactions")
                    .font(.caption)
                    .foregroundColor(.secondary)
            }
        }
    }

    private var formattedTotal: String {
        // Use same currency formatting as Transaction.formattedAmount
        String(format: "â‚ª%.2f", total)
    }
}
```

Use DisclosureGroup for expandable sections - tap to reveal transactions under each category.
  </action>
  <verify>
Xcode build succeeds.
Preview renders CategorySpendingView.
  </verify>
  <done>CategorySpendingView shows transactions grouped by category with spending totals, expandable sections reveal individual transactions</done>
</task>

<task type="auto">
  <name>Task 2: Integrate Category Views into Navigation</name>
  <files>
apps/finance/finance/Views/HomeView.swift
  </files>
  <action>
Update HomeView to provide access to category features. Options:

**Option A: TabView (if not already using tabs)**
Convert to TabView with:
- Transactions tab (existing TransactionListView)
- Spending tab (CategorySpendingView)
- Categories tab (CategoryListView for management)

**Option B: Toolbar additions (simpler)**
Add toolbar items to existing TransactionListView navigation:
- "Categories" button that presents CategoryListView as sheet
- "By Category" button that navigates to CategorySpendingView

**Recommended: TabView approach for clean navigation:**

```swift
struct HomeView: View {
    var body: some View {
        TabView {
            NavigationStack {
                TransactionListView()
            }
            .tabItem {
                Label("Transactions", systemImage: "list.bullet")
            }

            NavigationStack {
                CategorySpendingView()
            }
            .tabItem {
                Label("Spending", systemImage: "chart.pie")
            }

            NavigationStack {
                CategoryListView()
            }
            .tabItem {
                Label("Categories", systemImage: "tag")
            }
        }
    }
}
```

This gives clear entry points to:
1. Transaction list (browse, filter, tap for details)
2. Spending by category (see breakdown, analyze spending)
3. Category management (create/delete custom categories)
  </action>
  <verify>
Xcode build succeeds.
App launches and shows TabView with 3 tabs.
Each tab navigates correctly.
  </verify>
  <done>HomeView provides TabView navigation to Transactions, Spending by Category, and Category Management views</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete categorization feature across API and iOS app:
- Categories API with defaults and custom category support
- Transaction PATCH endpoint for category/notes assignment
- Category management UI (list, create, delete)
- Transaction detail view with category picker and notes
- Category-grouped spending view
- TabView navigation between features
  </what-built>
  <how-to-verify>
1. Start API: `turbo dev --filter=api`
2. Run iOS app in simulator

**Test Category Management:**
3. Go to Categories tab
4. Verify 8 default categories shown (food, clothes, transit, etc.)
5. Tap + to create a custom category
6. Enter name "Groceries", tap Create
7. Verify "Groceries" appears in My Categories section
8. Swipe to delete "Groceries" - should work
9. Try to swipe a default category - should NOT be deletable

**Test Transaction Categorization:**
10. Go to Transactions tab
11. Tap any transaction to open detail view
12. Verify transaction info displayed (merchant, amount, date)
13. Tap Category picker, select "Food"
14. Add a note like "Weekly groceries"
15. Tap Save
16. Go back to list - transaction should show food icon

**Test Category Spending View:**
17. Go to Spending tab
18. Verify categories with transactions shown with totals
19. Tap a category to expand and see transactions
20. Verify uncategorized transactions shown separately
21. Tap a transaction to edit its category
  </how-to-verify>
  <resume-signal>Type "approved" if all features work correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. API endpoints verified:
   - GET /categories returns 8 defaults + any custom
   - POST /categories creates custom category
   - DELETE /categories/:id removes custom category
   - PATCH /transactions/:id updates category and notes
2. iOS app verified:
   - All 3 tabs navigate correctly
   - Category CRUD works
   - Transaction detail view edits work
   - Category spending view groups correctly
   - Pull-to-refresh works on all views
</verification>

<success_criteria>
- Transactions grouped by category with spending totals
- Expandable sections show individual transactions
- Uncategorized transactions shown in separate group
- Navigation between all category features smooth
- Complete categorization workflow functional end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/03-categorization/03-05-SUMMARY.md`
</output>
