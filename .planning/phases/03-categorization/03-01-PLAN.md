---
phase: 03-categorization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/database/prisma/schema.prisma
  - apps/api/src/categories/dto/category.dto.ts
  - apps/api/src/categories/dto/index.ts
  - apps/api/src/categories/categories.service.ts
  - apps/api/src/categories/categories.controller.ts
  - apps/api/src/categories/categories.module.ts
  - apps/api/src/app.module.ts
autonomous: true

must_haves:
  truths:
    - "Categories table exists in database with name, icon, color, is_default, user_id fields"
    - "Default categories are seeded and returned for all users"
    - "User can create custom categories via POST /categories"
    - "User can list their categories (defaults + custom) via GET /categories"
    - "User can delete their custom categories via DELETE /categories/:id"
  artifacts:
    - path: "packages/database/prisma/schema.prisma"
      provides: "categories model with user relation and is_default flag"
      contains: "model categories"
    - path: "apps/api/src/categories/categories.controller.ts"
      provides: "GET, POST, DELETE endpoints for categories"
      exports: ["CategoriesController"]
    - path: "apps/api/src/categories/categories.service.ts"
      provides: "Category CRUD operations with default category handling"
      exports: ["CategoriesService"]
  key_links:
    - from: "apps/api/src/categories/categories.controller.ts"
      to: "CategoriesService"
      via: "dependency injection"
      pattern: "constructor.*CategoriesService"
    - from: "apps/api/src/categories/categories.service.ts"
      to: "prisma.categories"
      via: "database query"
      pattern: "prisma\\.categories\\.(find|create|delete)"
---

<objective>
Create the categories database table and NestJS API module for category management.

Purpose: Foundation for transaction categorization - categories must exist before they can be assigned to transactions.
Output: Categories table in Prisma schema, REST API endpoints for CRUD operations, default categories seeded.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-transaction-viewing/02-01-SUMMARY.md

Reference for NestJS module pattern:
@apps/api/src/transactions/transactions.module.ts
@apps/api/src/transactions/transactions.controller.ts
@apps/api/src/transactions/transactions.service.ts
@apps/api/src/transactions/dto/transaction.dto.ts

Database schema:
@packages/database/prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Categories Model to Prisma Schema</name>
  <files>packages/database/prisma/schema.prisma</files>
  <action>
Add a `categories` model to the Prisma schema with the following fields:
- id: UUID with gen_random_uuid() default (same pattern as other models)
- created_at: DateTime with now() default
- updated_at: DateTime with now() default
- name: String (required, max 50 chars)
- icon: String (optional, for SF Symbol name like "cart.fill", "fork.knife")
- color: String (optional, hex color like "#FF5733")
- is_default: Boolean default false (true for system defaults)
- user_id: UUID nullable (null for default categories, set for custom)

Add relation to users model (optional - only for custom categories).
Add unique constraint on [user_id, name] to prevent duplicate category names per user.
Add index on user_id for query performance.

Use @@schema("public") like other models.

Run `npx prisma db push` to apply schema changes (no migration needed for development).
  </action>
  <verify>
`npx prisma db push` succeeds without errors.
`npx prisma studio` shows categories table with correct columns.
  </verify>
  <done>categories table exists in database with all specified fields and constraints</done>
</task>

<task type="auto">
  <name>Task 2: Create Categories NestJS Module</name>
  <files>
apps/api/src/categories/dto/category.dto.ts
apps/api/src/categories/dto/index.ts
apps/api/src/categories/categories.service.ts
apps/api/src/categories/categories.controller.ts
apps/api/src/categories/categories.module.ts
apps/api/src/app.module.ts
  </files>
  <action>
Create the categories module following the established pattern from transactions module:

**DTOs (apps/api/src/categories/dto/category.dto.ts):**
```typescript
// CategorySchema with: id, name, icon, color, isDefault
// CreateCategorySchema with: name (required), icon (optional), color (optional)
// CategoriesResponseSchema with: categories array
```
Use Zod schemas with createZodDto like transactions module.

**Service (apps/api/src/categories/categories.service.ts):**
- `findAll(userId: string)`: Return all default categories (user_id is null) PLUS user's custom categories. Map snake_case to camelCase.
- `create(userId: string, data: CreateCategoryDto)`: Create custom category with is_default=false, user_id set.
- `delete(userId: string, categoryId: string)`: Delete only if category belongs to user AND is_default=false. Throw ForbiddenException if trying to delete default category.
- `seedDefaults()`: Called on module init to seed default categories if they don't exist.

**Default categories to seed** (all with is_default=true, user_id=null):
- food (icon: "fork.knife", color: "#FF9500")
- clothes (icon: "tshirt.fill", color: "#AF52DE")
- transit (icon: "car.fill", color: "#007AFF")
- subscriptions (icon: "repeat", color: "#5856D6")
- entertainment (icon: "film.fill", color: "#FF2D55")
- health (icon: "heart.fill", color: "#FF3B30")
- bills (icon: "doc.text.fill", color: "#34C759")
- other (icon: "ellipsis.circle.fill", color: "#8E8E93")

**Controller (apps/api/src/categories/categories.controller.ts):**
- GET /categories - List all categories (defaults + user's custom)
- POST /categories - Create custom category
- DELETE /categories/:id - Delete custom category

All endpoints protected with @UseGuards(JwtAuthGuard), @ApiBearerAuth(), proper Swagger docs.

**Module (apps/api/src/categories/categories.module.ts):**
Import DatabaseModule and AuthModule (same pattern as TransactionsModule).
Implement OnModuleInit to call seedDefaults().

**Registration:**
Import CategoriesModule in app.module.ts.
  </action>
  <verify>
`cd apps/api && npm run build` succeeds.
`cd apps/api && npm run lint` passes.
API starts and Swagger shows /categories endpoints.
GET /categories returns the 8 default categories.
  </verify>
  <done>Categories API fully functional with GET (list), POST (create custom), DELETE (remove custom) endpoints. Default categories seeded on startup.</done>
</task>

</tasks>

<verification>
1. `cd packages/database && npx prisma db push` - schema applied
2. `cd apps/api && npm run build && npm run lint` - builds and lints clean
3. `turbo dev --filter=api` - API starts without errors
4. Visit http://localhost:3000/api - Swagger shows categories endpoints
5. Test with curl:
   - `curl http://localhost:3000/categories` (with auth) returns 8 default categories
   - POST new category works
   - DELETE custom category works
   - DELETE default category returns 403 Forbidden
</verification>

<success_criteria>
- Categories table in database with correct schema
- 8 default categories seeded automatically on API startup
- GET /categories returns defaults + user's custom categories
- POST /categories creates custom category for authenticated user
- DELETE /categories/:id removes custom category (not defaults)
- All endpoints protected with JWT auth
- Swagger documentation complete
</success_criteria>

<output>
After completion, create `.planning/phases/03-categorization/03-01-SUMMARY.md`
</output>
