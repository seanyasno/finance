---
phase: 03-categorization
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - apps/finance/finance/Models/Category.swift
  - apps/finance/finance/Services/CategoryService.swift
  - apps/finance/finance/Views/Categories/CategoryRowView.swift
  - apps/finance/finance/Views/Categories/CategoryListView.swift
  - apps/finance/finance/Views/Categories/CreateCategoryView.swift
autonomous: true

must_haves:
  truths:
    - "User can see list of all categories (defaults + custom)"
    - "User can create a new custom category with name"
    - "User can delete their custom categories (not defaults)"
    - "Category list distinguishes default from custom categories"
  artifacts:
    - path: "apps/finance/finance/Models/Category.swift"
      provides: "Category model matching API response"
      contains: "struct Category"
    - path: "apps/finance/finance/Services/CategoryService.swift"
      provides: "CRUD operations for categories"
      contains: "class CategoryService"
    - path: "apps/finance/finance/Views/Categories/CategoryListView.swift"
      provides: "Category management UI"
      contains: "struct CategoryListView"
  key_links:
    - from: "apps/finance/finance/Views/Categories/CategoryListView.swift"
      to: "CategoryService"
      via: "@StateObject"
      pattern: "@StateObject.*CategoryService"
    - from: "apps/finance/finance/Services/CategoryService.swift"
      to: "/categories"
      via: "APIService fetch"
      pattern: "apiService\\.(fetch|post|delete)"
---

<objective>
Create iOS Category model, service, and management UI for viewing and creating categories.

Purpose: Allow users to manage their categories from the iOS app - prerequisite for assigning categories to transactions.
Output: Category model, CategoryService, CategoryListView with create and delete capabilities.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-transaction-viewing/02-02-SUMMARY.md

Reference for iOS model and service patterns:
@apps/finance/finance/Models/Transaction.swift
@apps/finance/finance/Models/CreditCard.swift
@apps/finance/finance/Services/TransactionService.swift
@apps/finance/finance/Services/APIService.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Category Model and Service</name>
  <files>
apps/finance/finance/Models/Category.swift
apps/finance/finance/Services/CategoryService.swift
  </files>
  <action>
**Category Model (apps/finance/finance/Models/Category.swift):**

Create Category struct matching the API response:
```swift
struct Category: Codable, Identifiable {
    let id: String
    let name: String
    let icon: String?
    let color: String?
    let isDefault: Bool

    enum CodingKeys: String, CodingKey {
        case id, name, icon, color
        case isDefault
    }
}
```

Add computed properties:
- `displayIcon: String` - Returns icon or "tag.fill" as fallback
- `displayColor: Color` - Parses hex color or returns .gray as fallback
- `isCustom: Bool` - Inverse of isDefault for convenience

Add response wrapper:
```swift
struct CategoriesResponse: Codable {
    let categories: [Category]
}
```

Add create request struct:
```swift
struct CreateCategoryRequest: Codable {
    let name: String
    let icon: String?
    let color: String?
}
```

**CategoryService (apps/finance/finance/Services/CategoryService.swift):**

Create @MainActor class with @Published properties following TransactionService pattern:
```swift
@MainActor
class CategoryService: ObservableObject {
    @Published var categories: [Category] = []
    @Published var isLoading = false
    @Published var error: String?

    private let apiService = APIService.shared
}
```

Methods:
- `fetchCategories() async` - GET /categories, decode CategoriesResponse, update categories array
- `createCategory(name: String, icon: String?, color: String?) async -> Bool` - POST /categories with CreateCategoryRequest body, return true on success, refresh list
- `deleteCategory(id: String) async -> Bool` - DELETE /categories/{id}, return true on success, refresh list

Computed property:
- `defaultCategories: [Category]` - Filter where isDefault == true
- `customCategories: [Category]` - Filter where isDefault == false
  </action>
  <verify>
Xcode build succeeds for finance target.
No compiler errors in Category.swift or CategoryService.swift.
  </verify>
  <done>Category model matches API schema, CategoryService provides fetch/create/delete operations</done>
</task>

<task type="auto">
  <name>Task 2: Create Category Management UI</name>
  <files>
apps/finance/finance/Views/Categories/CategoryRowView.swift
apps/finance/finance/Views/Categories/CategoryListView.swift
apps/finance/finance/Views/Categories/CreateCategoryView.swift
  </files>
  <action>
Create Views/Categories directory and the following views:

**CategoryRowView (CategoryRowView.swift):**
Simple row for displaying a category in a list:
```swift
struct CategoryRowView: View {
    let category: Category

    var body: some View {
        HStack {
            Image(systemName: category.displayIcon)
                .foregroundColor(category.displayColor)
                .frame(width: 30)
            Text(category.name)
            Spacer()
            if category.isDefault {
                Text("Default")
                    .font(.caption)
                    .foregroundColor(.secondary)
            }
        }
    }
}
```

**CategoryListView (CategoryListView.swift):**
Main category management view:
- @StateObject CategoryService
- NavigationStack with "Categories" title
- Two sections: "Default Categories" and "My Categories"
- Default categories section shows all defaults (non-deletable)
- Custom categories section shows user's custom categories with swipe-to-delete
- Toolbar button (plus icon) to add new category
- Sheet presentation for CreateCategoryView
- Loading, error, and empty states (following TransactionListView patterns)
- Pull-to-refresh to reload categories

```swift
struct CategoryListView: View {
    @StateObject private var categoryService = CategoryService()
    @State private var showCreateSheet = false
    // ... implementation
}
```

**CreateCategoryView (CreateCategoryView.swift):**
Form for creating a new category:
- @Environment(\.dismiss) for sheet dismissal
- TextField for category name (required)
- Optional icon picker (simple TextField for SF Symbol name, or predefined list)
- Optional color picker (use SwiftUI ColorPicker or predefined swatches)
- "Create" button that calls categoryService.createCategory()
- Dismiss on success
- Show error if creation fails

Keep it simple - name is required, icon/color are optional enhancements.
  </action>
  <verify>
Xcode build succeeds.
Preview renders for CategoryRowView, CategoryListView, CreateCategoryView.
  </verify>
  <done>Category management UI allows viewing all categories, creating custom categories, and deleting custom categories</done>
</task>

</tasks>

<verification>
1. Xcode build succeeds for finance target
2. All previews render without crashes
3. CategoryListView shows loading state initially
4. After API call, default categories appear in "Default Categories" section
5. Can tap + to open CreateCategoryView
6. Can create new category and see it appear in "My Categories" section
7. Can swipe-to-delete custom categories
8. Cannot delete default categories
</verification>

<success_criteria>
- Category model decodes API response correctly
- CategoryService fetches, creates, and deletes categories
- CategoryListView displays categories in two sections (default/custom)
- CreateCategoryView allows creating new categories with name
- Delete gesture works only for custom categories
- Proper loading, error, and empty states
</success_criteria>

<output>
After completion, create `.planning/phases/03-categorization/03-03-SUMMARY.md`
</output>
