---
phase: 02-transaction-viewing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/transactions/dto/transaction.dto.ts
  - apps/api/src/transactions/dto/index.ts
  - apps/api/src/transactions/transactions.service.ts
  - apps/api/src/transactions/transactions.controller.ts
  - apps/api/src/transactions/transactions.module.ts
  - apps/api/src/credit-cards/dto/credit-card.dto.ts
  - apps/api/src/credit-cards/dto/index.ts
  - apps/api/src/credit-cards/credit-cards.service.ts
  - apps/api/src/credit-cards/credit-cards.controller.ts
  - apps/api/src/credit-cards/credit-cards.module.ts
  - apps/api/src/app.module.ts
autonomous: true

must_haves:
  truths:
    - "GET /transactions returns array of transactions for authenticated user"
    - "GET /transactions accepts startDate, endDate, creditCardId query params"
    - "GET /credit-cards returns array of user's credit cards"
    - "All endpoints require authentication (401 without token)"
  artifacts:
    - path: "apps/api/src/transactions/transactions.controller.ts"
      provides: "GET /transactions endpoint with filters"
      exports: ["TransactionsController"]
    - path: "apps/api/src/transactions/transactions.service.ts"
      provides: "Database queries with Prisma"
      exports: ["TransactionsService"]
    - path: "apps/api/src/credit-cards/credit-cards.controller.ts"
      provides: "GET /credit-cards endpoint"
      exports: ["CreditCardsController"]
  key_links:
    - from: "apps/api/src/transactions/transactions.controller.ts"
      to: "apps/api/src/transactions/transactions.service.ts"
      via: "dependency injection"
      pattern: "constructor.*TransactionsService"
    - from: "apps/api/src/transactions/transactions.service.ts"
      to: "prisma.transactions"
      via: "database query"
      pattern: "prisma\\.transactions\\.findMany"
    - from: "apps/api/src/app.module.ts"
      to: "TransactionsModule"
      via: "module import"
      pattern: "imports.*TransactionsModule"
---

<objective>
Create NestJS API endpoints for transactions and credit cards with filtering support.

Purpose: Backend foundation for transaction viewing - iOS app needs these endpoints to fetch and filter transaction data
Output: Working API endpoints at /transactions and /credit-cards with authentication
</objective>

<execution_context>
@/Users/seanyasno/.claude/get-shit-done/workflows/execute-plan.md
@/Users/seanyasno/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context - auth patterns to follow
@.planning/phases/01-ios-foundation/01-01-SUMMARY.md

# Existing API patterns
@apps/api/src/auth/auth.module.ts
@apps/api/src/auth/auth.controller.ts
@apps/api/src/auth/auth.service.ts
@apps/api/src/auth/dto/index.ts

# Database schema - understand transaction and credit_card tables
@packages/database/prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Transactions Module with DTOs, Service, and Controller</name>
  <files>
    apps/api/src/transactions/dto/transaction.dto.ts
    apps/api/src/transactions/dto/index.ts
    apps/api/src/transactions/transactions.service.ts
    apps/api/src/transactions/transactions.controller.ts
    apps/api/src/transactions/transactions.module.ts
  </files>
  <action>
Create the transactions module following the auth module pattern:

1. **dto/transaction.dto.ts** - Define DTOs using Zod schemas (follow auth/dto pattern):
   - TransactionDto: id, description, timestamp, notes, originalAmount, originalCurrency, chargedAmount, chargedCurrency, status, creditCardId, creditCard (nested)
   - TransactionQueryDto: startDate (optional ISO string), endDate (optional ISO string), creditCardId (optional UUID)
   - TransactionsResponseDto: transactions array
   - Include creditCard nested object with: id, cardNumber, company

2. **dto/index.ts** - Export all DTOs

3. **transactions.service.ts** - Create service with:
   - Constructor injection of PrismaService from @finance/database
   - `findAll(userId: string, query: TransactionQueryDto)` method that:
     - Builds Prisma where clause with user_id = userId
     - Adds timestamp >= startDate if provided (parse ISO string to Date)
     - Adds timestamp <= endDate if provided
     - Adds credit_card_id = creditCardId if provided
     - Orders by timestamp DESC
     - Includes credit_card relation for card details
     - Returns transactions with camelCase field mapping

4. **transactions.controller.ts** - Create controller with:
   - Route prefix 'transactions'
   - GET / endpoint with @UseGuards(JwtAuthGuard)
   - @Query() for TransactionQueryDto
   - @CurrentUser() decorator to get authenticated user
   - Returns TransactionsResponseDto
   - Swagger decorations: @ApiTags, @ApiOperation, @ApiQuery for each filter, @ApiResponse

5. **transactions.module.ts** - Create module:
   - imports: [DatabaseModule from @finance/database]
   - controllers: [TransactionsController]
   - providers: [TransactionsService]
  </action>
  <verify>
Files created with correct structure. Run `cd apps/api && npm run lint` to verify no syntax errors.
  </verify>
  <done>
Transactions module exists with DTO, service, and controller. Service queries database with filters.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Credit Cards Module</name>
  <files>
    apps/api/src/credit-cards/dto/credit-card.dto.ts
    apps/api/src/credit-cards/dto/index.ts
    apps/api/src/credit-cards/credit-cards.service.ts
    apps/api/src/credit-cards/credit-cards.controller.ts
    apps/api/src/credit-cards/credit-cards.module.ts
  </files>
  <action>
Create credit-cards module for the filter dropdown:

1. **dto/credit-card.dto.ts** - Define DTOs:
   - CreditCardDto: id, cardNumber, company, createdAt
   - CreditCardsResponseDto: creditCards array

2. **dto/index.ts** - Export all DTOs

3. **credit-cards.service.ts** - Create service with:
   - Constructor injection of PrismaService
   - `findAll(userId: string)` method that:
     - Queries credit_cards where user_id = userId
     - Orders by created_at ASC
     - Returns cards with camelCase mapping

4. **credit-cards.controller.ts** - Create controller with:
   - Route prefix 'credit-cards'
   - GET / endpoint with @UseGuards(JwtAuthGuard)
   - @CurrentUser() for authenticated user
   - Returns CreditCardsResponseDto
   - Swagger decorations

5. **credit-cards.module.ts** - Create module:
   - imports: [DatabaseModule]
   - controllers: [CreditCardsController]
   - providers: [CreditCardsService]
  </action>
  <verify>
Files created. Run `cd apps/api && npm run lint` passes.
  </verify>
  <done>
Credit cards module exists and can return user's cards for filter dropdown.
  </done>
</task>

<task type="auto">
  <name>Task 3: Register Modules and Test Endpoints</name>
  <files>
    apps/api/src/app.module.ts
  </files>
  <action>
1. Update app.module.ts to import both new modules:
   - Add TransactionsModule to imports array
   - Add CreditCardsModule to imports array

2. Start the API server and test with curl:
   ```bash
   cd apps/api && npm run start:dev &
   sleep 5

   # Test without auth (should get 401)
   curl -s http://127.0.0.1:3100/transactions | head -20

   # Test credit-cards without auth (should get 401)
   curl -s http://127.0.0.1:3100/credit-cards | head -20
   ```

3. Verify Swagger docs are generated at http://127.0.0.1:3100/api

Note: Full integration testing with auth will happen in Phase 2 Plan 03 when iOS UI is ready.
  </action>
  <verify>
`npm run start:dev` starts without errors. Endpoints return 401 when accessed without authentication (correct behavior). Swagger shows new endpoints.
  </verify>
  <done>
Both modules registered in app.module.ts. API starts and endpoints are accessible (require auth as expected).
  </done>
</task>

</tasks>

<verification>
1. `cd apps/api && npm run lint` passes with no errors
2. `cd apps/api && npm run build` compiles successfully
3. API starts with `npm run start:dev`
4. GET /transactions returns 401 without auth token
5. GET /credit-cards returns 401 without auth token
6. Swagger UI at /api shows both new endpoints with query parameters documented
</verification>

<success_criteria>
- Transactions module created with filtering by date range and credit card
- Credit cards module created for filter dropdown data
- Both modules registered in app.module.ts
- Endpoints protected by JwtAuthGuard
- API compiles and runs without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-transaction-viewing/02-01-SUMMARY.md`
</output>
