---
phase: 02-transaction-viewing
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/finance/finance/Models/Transaction.swift
  - apps/finance/finance/Models/CreditCard.swift
  - apps/finance/finance/Services/TransactionService.swift
autonomous: true

must_haves:
  truths:
    - "Transaction model can decode JSON from /transactions endpoint"
    - "CreditCard model can decode JSON from /credit-cards endpoint"
    - "TransactionService can fetch transactions with optional date and card filters"
    - "TransactionService can fetch list of credit cards"
  artifacts:
    - path: "apps/finance/finance/Models/Transaction.swift"
      provides: "Transaction data model"
      contains: "struct Transaction"
    - path: "apps/finance/finance/Models/CreditCard.swift"
      provides: "CreditCard data model"
      contains: "struct CreditCard"
    - path: "apps/finance/finance/Services/TransactionService.swift"
      provides: "API service for transactions"
      exports: ["TransactionService"]
  key_links:
    - from: "apps/finance/finance/Services/TransactionService.swift"
      to: "apps/finance/finance/Services/APIService.swift"
      via: "property reference"
      pattern: "apiService.*get"
    - from: "apps/finance/finance/Models/Transaction.swift"
      to: "apps/finance/finance/Models/CreditCard.swift"
      via: "nested type"
      pattern: "creditCard.*CreditCard"
---

<objective>
Create Swift data models and service layer for transactions and credit cards.

Purpose: Data layer for iOS transaction viewing - models decode API responses, service handles API calls
Output: Transaction and CreditCard models, TransactionService with fetch methods
</objective>

<execution_context>
@/Users/seanyasno/.claude/get-shit-done/workflows/execute-plan.md
@/Users/seanyasno/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase patterns - auth models and service patterns
@.planning/phases/01-ios-foundation/01-01-SUMMARY.md

# Existing iOS patterns
@apps/finance/finance/Models/User.swift
@apps/finance/finance/Models/AuthModels.swift
@apps/finance/finance/Services/APIService.swift
@apps/finance/finance/Services/AuthManager.swift

# Database schema for field reference
@packages/database/prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Transaction and CreditCard Models</name>
  <files>
    apps/finance/finance/Models/Transaction.swift
    apps/finance/finance/Models/CreditCard.swift
  </files>
  <action>
Create Swift models matching the API response structure:

1. **CreditCard.swift** - Credit card model:
   ```swift
   struct CreditCard: Codable, Identifiable, Hashable {
       let id: String
       let cardNumber: String
       let company: String
       let createdAt: String?  // Optional for nested in transaction
   }
   ```
   - Conforms to Codable for JSON decoding
   - Conforms to Identifiable for SwiftUI lists
   - Conforms to Hashable for use in filters/pickers

2. **Transaction.swift** - Transaction model:
   ```swift
   struct Transaction: Codable, Identifiable {
       let id: String
       let description: String?
       let timestamp: String  // ISO date string
       let notes: String?
       let originalAmount: Double
       let originalCurrency: String
       let chargedAmount: Double
       let chargedCurrency: String?
       let status: String  // "completed" or "pending"
       let creditCardId: String?
       let creditCard: CreditCard?
   }
   ```
   - All fields match API response
   - Use String for dates (simpler than custom Date decoding)
   - creditCard is optional nested object

3. Add computed properties for display:
   - `formattedAmount` -> returns chargedAmount with currency symbol
   - `formattedDate` -> returns human-readable date from timestamp
   - `merchantName` -> returns description or "Unknown"
  </action>
  <verify>
Build iOS project in Xcode: Product > Build (Cmd+B). No compilation errors.
  </verify>
  <done>
Transaction and CreditCard models exist with all API fields and display helpers.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TransactionService</name>
  <files>
    apps/finance/finance/Services/TransactionService.swift
  </files>
  <action>
Create service for transaction and credit card API calls:

1. **TransactionService.swift**:
   ```swift
   @MainActor
   class TransactionService: ObservableObject {
       private let apiService: APIService

       @Published var transactions: [Transaction] = []
       @Published var creditCards: [CreditCard] = []
       @Published var isLoading = false
       @Published var error: String?

       init(apiService: APIService = APIService()) {
           self.apiService = apiService
       }

       // Fetch transactions with optional filters
       func fetchTransactions(
           startDate: Date? = nil,
           endDate: Date? = nil,
           creditCardId: String? = nil
       ) async { ... }

       // Fetch credit cards for filter dropdown
       func fetchCreditCards() async { ... }
   }
   ```

2. **fetchTransactions implementation**:
   - Build query string from optional parameters
   - startDate/endDate: convert to ISO8601 string if provided
   - creditCardId: add as query param if provided
   - Call apiService.get("/transactions?\(queryString)", authenticated: true)
   - Decode TransactionsResponse { transactions: [Transaction] }
   - Update @Published transactions array
   - Handle errors by setting error property

3. **fetchCreditCards implementation**:
   - Call apiService.get("/credit-cards", authenticated: true)
   - Decode CreditCardsResponse { creditCards: [CreditCard] }
   - Update @Published creditCards array
   - Handle errors

4. Add response wrapper structs:
   ```swift
   struct TransactionsResponse: Codable {
       let transactions: [Transaction]
   }

   struct CreditCardsResponse: Codable {
       let creditCards: [CreditCard]
   }
   ```
  </action>
  <verify>
Build iOS project in Xcode: Product > Build (Cmd+B). No compilation errors.
  </verify>
  <done>
TransactionService exists with fetchTransactions (with filters) and fetchCreditCards methods.
  </done>
</task>

</tasks>

<verification>
1. Xcode builds iOS target without errors (Cmd+B)
2. Transaction model has all fields from API (description, timestamp, amounts, creditCard)
3. CreditCard model has all fields (id, cardNumber, company)
4. TransactionService has fetchTransactions with date/card filter parameters
5. TransactionService has fetchCreditCards for filter dropdown
6. All models conform to Codable for JSON decoding
</verification>

<success_criteria>
- Transaction and CreditCard models match API response structure
- TransactionService can build filtered query strings
- Service uses existing APIService for HTTP calls
- All code compiles in Xcode
- Models ready for use in UI layer (Plan 03)
</success_criteria>

<output>
After completion, create `.planning/phases/02-transaction-viewing/02-02-SUMMARY.md`
</output>
